////////////////////////////////////////////////////////////////////////////////
// SMAL
//
// Namespace: Smal
// Version: 0.96
//
//  AUTHOR: Song Ho Ahn (song.ahn@gmail.com)
// CREATED: 2023-06-09, 23:39:13
///////////////////////////////////////////////////////////////////////////////
let Smal=createNamespace("Smal");function createNamespace(t){let i=t.split("."),e=window,s="";for(let t=0,r=i.length;t<r;++t)e[s=i[t]]=e[s]||{},e=e[s];return e}Smal.version=.96,Smal.AnimationMode={LINEAR:0,EASE_IN:1,EASE_IN2:2,EASE_OUT:3,EASE_OUT2:4,EASE_IN_OUT:5,EASE_IN_OUT2:6,BOUNCE:7,ELASTIC:8},Smal.Vector2=function(t=0,i=0){this.x=t,this.y=i},Smal.Vector2.prototype={set:function(t=0,i=0){return t instanceof Smal.Vector2?(this.x=t.x,this.y=t.y):(this.x=t,this.y=i),this},add:function(t){return this.x+=t.x,this.y+=t.y,this},subtract:function(t){return this.x-=t.x,this.y-=t.y,this},scale:function(t){return this.x*=t,this.y*=t,this},dot:function(t){return this.x*t.x+this.y*t.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){let t=this.x*this.x+this.y*this.y;if(t<1e-6)return this;let i=1/Math.sqrt(t);return this.x*=i,this.y*=i,this},distance:function(t){return Math.sqrt((this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y))},clone:function(){return new Smal.Vector2(this.x,this.y)},equals:function(t){return t&&this.x==t.x&&this.y==t.y},toFloat32Array:function(){return new Float32Array([this.x,this.y])},toString:function(){return"Vector2("+Math.round(1e5*this.x)/1e5+", "+Math.round(1e5*this.y)/1e5+")"}},Smal.Vector2.interpolate=function(t,i,e,s){let r=Smal.getInterpolateAlpha(e,s),n=new Smal.Vector2(t.x,t.y),o=new Smal.Vector2(i.x-t.x,i.y-t.y);return n.add(o.scale(r))},Smal.Vector3=function(t=0,i=0,e=0){this.x=t,this.y=i,this.z=e},Smal.Vector3.prototype={set:function(t=0,i=0,e=0){return t instanceof Smal.Vector3?(this.x=t.x,this.y=t.y,this.z=t.z):t instanceof Smal.Vector2?(this.x=t.x,this.y=t.y,this.z=0):(this.x=t,this.y=i,this.z=e),this},add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},subtract:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},scale:function(t){return this.x*=t,this.y*=t,this.z*=t,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){let t=this.x*this.x+this.y*this.y+this.z*this.z;if(t<1e-6)return this;let i=1/Math.sqrt(t);return this.x*=i,this.y*=i,this.z*=i,this},distance:function(t){return Math.sqrt((this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y)+(this.z-t.z)*(this.z-t.z))},clone:function(){return new Smal.Vector3(this.x,this.y,this.z)},equals:function(t){return t&&this.x==t.x&&this.y==t.y&&this.z==t.z},toFloat32Array:function(){return new Float32Array([this.x,this.y,this.z])},toString:function(){return"Vector3("+Math.round(1e5*this.x)/1e5+", "+Math.round(1e5*this.y)/1e5+", "+Math.round(1e5*this.z)/1e5+")"}},Smal.Vector3.cross=function(t,i){let e=t.y*i.z-t.z*i.y,s=t.z*i.x-t.x*i.z,r=t.x*i.y-t.y*i.x;return new Smal.Vector3(e,s,r)},Smal.Vector3.interpolate=function(t,i,e,s){let r=Smal.getInterpolateAlpha(e,s),n=new Smal.Vector3(t.x,t.y,t.z),o=new Smal.Vector3(i.x-t.x,i.y-t.y,i.z-t.z);return n.add(o.scale(r))},Smal.Vector4=function(t=0,i=0,e=0,s=0){this.x=t,this.y=i,this.z=e,this.w=s},Smal.Vector4.prototype={set:function(t=0,i=0,e=0,s=0){return t instanceof Smal.Vector4?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):t instanceof Smal.Vector3?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=i||0):(this.x=t,this.y=i,this.z=e,this.w=s),this},add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},subtract:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},scale:function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){let t=this.x*this.x+this.y*this.y+this.z*this.z;if(t<1e-6)return this;let i=1/Math.sqrt(t);return this.x*=i,this.y*=i,this.z*=i,this},distance:function(t){let i=this.x-t.x,e=this.y-t.y,s=this.z-t.z,r=this.w-t.w;return Math.sqrt(i*i+e*e+s*s+r*r)},clone:function(){return new Smal.Vector4(this.x,this.y,this.z,this.w)},equals:function(t){return t&&this.x==t.x&&this.y==t.y&&this.z==t.z&&this.w==t.w},toFloat32Array:function(){return new Float32Array([this.x,this.y,this.z,this.w])},toString:function(){return"Vector4("+Math.round(1e5*this.x)/1e5+", "+Math.round(1e5*this.y)/1e5+", "+Math.round(1e5*this.z)/1e5+", "+Math.round(1e5*this.w)/1e5+")"}},Smal.Matrix3=function(t,i,e,s,r,n,o,h,a){this.m=new Float32Array(9),this.set(t,i,e,s,r,n,o,h,a)},Smal.Matrix3.prototype={set:function(t=1,i=0,e=0,s=0,r=1,n=0,o=0,h=0,a=1){return this.m[0]=t,this.m[3]=s,this.m[6]=o,this.m[1]=i,this.m[4]=r,this.m[7]=h,this.m[2]=e,this.m[5]=n,this.m[8]=a,this},identity:function(){return this.m[0]=1,this.m[3]=0,this.m[6]=0,this.m[1]=0,this.m[4]=1,this.m[7]=0,this.m[2]=0,this.m[5]=0,this.m[8]=1,this},clone:function(){return new Smal.Matrix3(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8])},transpose:function(){let t;return t=this.m[1],this.m[1]=this.m[3],this.m[3]=t,t=this.m[2],this.m[2]=this.m[6],this.m[6]=t,t=this.m[5],this.m[5]=this.m[7],this.m[7]=t,this},getRow:function(t){return new Smal.Vector3(this.m[t],this.m[3+t],this.m[6+t])},getColumn:function(t){let i=3*t;return new Smal.Vector3(this.m[i],this.m[i+1],this.m[i+2])},getAngle:function(){let t,i,e=Math.asin(this.m[6]);return this.m[8]<0&&(e=e>=0?Math.PI-e:-Math.PI-e),this.m[0]>-1e-5&&this.m[0]<1e-5?(t=0,i=Math.atan2(this.m[1],this.m[4])):(t=Math.atan2(-this.m[3],this.m[0]),i=Math.atan2(-this.m[7],this.m[8])),new Smal.Vector3(i,e,t)},getAngleDegree:function(){let t=this.getAngle();return t.x=Smal.rad2deg(t.x),t.y=Smal.rad2deg(t.y),t.z=Smal.rad2deg(t.z),t},setRow:function(t,i){return this.m[t]=i.x,this.m[3+t]=i.y,this.m[6+t]=i.z,this},setColumn:function(t,i){let e=3*t;return this.m[e]=i.x,this.m[e+1]=i.y,this.m[e+2]=i.z,this},invert:function(){let t,i=new Array(9);if(i[0]=this.m[4]*this.m[8]-this.m[5]*this.m[7],i[1]=this.m[2]*this.m[7]-this.m[1]*this.m[8],i[2]=this.m[1]*this.m[5]-this.m[2]*this.m[4],i[3]=this.m[5]*this.m[6]-this.m[3]*this.m[8],i[4]=this.m[0]*this.m[8]-this.m[2]*this.m[6],i[5]=this.m[2]*this.m[3]-this.m[0]*this.m[5],i[6]=this.m[3]*this.m[7]-this.m[4]*this.m[6],i[7]=this.m[1]*this.m[6]-this.m[0]*this.m[7],i[8]=this.m[0]*this.m[4]-this.m[1]*this.m[3],t=this.m[0]*i[0]+this.m[1]*i[3]+this.m[2]*i[6],Math.abs(t)<=1e-5)throw"Matrix3 is not invertible.";return t=1/t,this.m[0]=t*i[0],this.m[1]=t*i[1],this.m[2]=t*i[2],this.m[3]=t*i[3],this.m[4]=t*i[4],this.m[5]=t*i[5],this.m[6]=t*i[6],this.m[7]=t*i[7],this.m[8]=t*i[8],this},multiply:function(t){let i=this.clone();return this.m[0]=i.m[0]*t.m[0]+i.m[3]*t.m[1]+i.m[6]*t.m[2],this.m[1]=i.m[1]*t.m[0]+i.m[4]*t.m[1]+i.m[7]*t.m[2],this.m[2]=i.m[2]*t.m[0]+i.m[5]*t.m[1]+i.m[8]*t.m[2],this.m[3]=i.m[0]*t.m[3]+i.m[3]*t.m[4]+i.m[6]*t.m[5],this.m[4]=i.m[1]*t.m[3]+i.m[4]*t.m[4]+i.m[7]*t.m[5],this.m[5]=i.m[2]*t.m[3]+i.m[5]*t.m[4]+i.m[8]*t.m[5],this.m[6]=i.m[0]*t.m[6]+i.m[3]*t.m[7]+i.m[6]*t.m[8],this.m[7]=i.m[1]*t.m[6]+i.m[4]*t.m[7]+i.m[7]*t.m[8],this.m[8]=i.m[2]*t.m[6]+i.m[5]*t.m[7]+i.m[8]*t.m[8],this},transform:function(t){let i=new Smal.Vector3;return i.x=this.m[0]*t.x+this.m[3]*t.y+this.m[6]*t.z,i.y=this.m[1]*t.x+this.m[4]*t.y+this.m[7]*t.z,i.z=this.m[2]*t.x+this.m[5]*t.y+this.m[8]*t.z,i},toString:function(){return"===== Matrix3 =====\n| "+this.m[0].toFixed(3)+" "+this.m[3].toFixed(3)+" "+this.m[6].toFixed(3)+" |\n| "+this.m[1].toFixed(3)+" "+this.m[4].toFixed(3)+" "+this.m[7].toFixed(3)+" |\n| "+this.m[2].toFixed(3)+" "+this.m[5].toFixed(3)+" "+this.m[8].toFixed(3)+" |\n"}},Smal.Matrix4=function(t,i,e,s,r,n,o,h,a,l,u,m,c,d,f,x){this.m=new Float32Array(16),this.set(t,i,e,s,r,n,o,h,a,l,u,m,c,d,f,x)},Smal.Matrix4.prototype={set:function(t=1,i=0,e=0,s=0,r=0,n=1,o=0,h=0,a=0,l=0,u=1,m=0,c=0,d=0,f=0,x=1){return this.m[0]=t,this.m[4]=r,this.m[8]=a,this.m[12]=c,this.m[1]=i,this.m[5]=n,this.m[9]=l,this.m[13]=d,this.m[2]=e,this.m[6]=o,this.m[10]=u,this.m[14]=f,this.m[3]=s,this.m[7]=h,this.m[11]=m,this.m[15]=x,this},clone:function(){return new Smal.Matrix4(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])},identity:function(){return this.m[0]=1,this.m[4]=0,this.m[8]=0,this.m[12]=0,this.m[1]=0,this.m[5]=1,this.m[9]=0,this.m[13]=0,this.m[2]=0,this.m[6]=0,this.m[10]=1,this.m[14]=0,this.m[3]=0,this.m[7]=0,this.m[11]=0,this.m[15]=1,this},transpose:function(){let t;return t=this.m[1],this.m[1]=this.m[4],this.m[4]=t,t=this.m[2],this.m[2]=this.m[8],this.m[8]=t,t=this.m[3],this.m[3]=this.m[12],this.m[12]=t,t=this.m[6],this.m[6]=this.m[9],this.m[9]=t,t=this.m[7],this.m[7]=this.m[13],this.m[13]=t,t=this.m[11],this.m[11]=this.m[14],this.m[14]=t,this},getLeftAxis:function(){return new Smal.Vector3(this.m[0],this.m[1],this.m[2])},getUpAxis:function(){return new Smal.Vector3(this.m[4],this.m[5],this.m[6])},getForwardAxis:function(){return new Smal.Vector3(this.m[8],this.m[9],this.m[10])},getRotationMatrix:function(){let t=new Smal.Vector3(this.m[0],this.m[1],this.m[2]),i=new Smal.Vector3(this.m[4],this.m[5],this.m[6]),e=new Smal.Vector3(this.m[8],this.m[9],this.m[10]);return t.normalize(),i.normalize(),e.normalize(),new Smal.Matrix4(t.x,t.y,t.z,0,i.x,i.y,i.z,0,e.x,e.y,e.z,0,0,0,0,1)},getAngle:function(){let t,i,e=Math.asin(this.m[8]);return this.m[10]<0&&(e=e>=0?Math.PI-e:-Math.PI-e),this.m[0]>-1e-5&&this.m[0]<1e-5?(t=0,i=Math.atan2(this.m[1],this.m[5])):(t=Math.atan2(-this.m[4],this.m[0]),i=Math.atan2(-this.m[9],this.m[10])),new Smal.Vector3(i,e,t)},getAngleDegree:function(){let t=this.getAngle();return t.x=Smal.rad2deg(t.x),t.y=Smal.rad2deg(t.y),t.z=Smal.rad2deg(t.z),t},getTranslation:function(){return new Smal.Vector3(this.m[12],this.m[13],this.m[14])},getRow:function(t){return new Smal.Vector4(this.m[t],this.m[4+t],this.m[8+t],this.m[12+t])},getColumn:function(t){let i=4*t;return new Smal.Vector4(this.m[i],this.m[i+1],this.m[i+2],this.m[i+3])},setRow:function(t,i){return this.m[t]=i.x,this.m[4+t]=i.y,this.m[8+t]=i.z,i instanceof Smal.Vector4&&(this.m[12+t]=i.w),this},setColumn:function(t,i){let e=4*t;return this.m[e]=i.x,this.m[e+1]=i.y,this.m[e+2]=i.z,i instanceof Smal.Vector4&&(this.m[e+3]=i.w),this},setLeftAxis:function(t,i,e){return this.m[0]=t,this.m[1]=i,this.m[2]=e,this},setUpAxis:function(t,i,e){return this.m[4]=t,this.m[5]=i,this.m[6]=e,this},setForwardAxis:function(t,i,e){return this.m[8]=t,this.m[9]=i,this.m[10]=e,this},setTranslation:function(t,i,e){return this.m[12]=t,this.m[13]=i,this.m[14]=e,this},invertEuclidean:function(){let t;t=this.m[1],this.m[1]=this.m[4],this.m[4]=t,t=this.m[2],this.m[2]=this.m[8],this.m[8]=t,t=this.m[6],this.m[6]=this.m[9],this.m[9]=t;let i=this.m[12],e=this.m[13],s=this.m[14];return this.m[12]=-(this.m[0]*i+this.m[4]*e+this.m[8]*s),this.m[13]=-(this.m[1]*i+this.m[5]*e+this.m[9]*s),this.m[14]=-(this.m[2]*i+this.m[6]*e+this.m[10]*s),this},invertAffine:function(){let t=this.m,i=new Smal.Matrix3(t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]);i.invert(),t[0]=i.m[0],t[4]=i.m[3],t[8]=i.m[6],t[1]=i.m[1],t[5]=i.m[4],t[9]=i.m[7],t[2]=i.m[2],t[6]=i.m[5],t[10]=i.m[8];let e=t[12],s=t[13],r=t[14];return t[12]=-(i.m[0]*e+i.m[3]*s+i.m[6]*r),t[13]=-(i.m[1]*e+i.m[4]*s+i.m[7]*r),t[14]=-(i.m[2]*e+i.m[5]*s+i.m[8]*r),this},getCofactor:function(t,i,e,s,r,n,o,h,a){return t*(r*a-n*h)-i*(s*a-n*o)+e*(s*h-r*o)},invertGeneral:function(){let t=this.m,i=this.getCofactor(t[5],t[6],t[7],t[9],t[10],t[11],t[13],t[14],t[15]),e=this.getCofactor(t[4],t[6],t[7],t[8],t[10],t[11],t[12],t[14],t[15]),s=this.getCofactor(t[4],t[5],t[7],t[8],t[9],t[11],t[12],t[13],t[15]),r=this.getCofactor(t[4],t[5],t[6],t[8],t[9],t[10],t[12],t[13],t[14]),n=t[0]*i-t[1]*e+t[2]*s-t[3]*r;if(Math.abs(n)<=1e-5)throw"Matrix4 is not invertible.";let o=this.getCofactor(t[1],t[2],t[3],t[9],t[10],t[11],t[13],t[14],t[15]),h=this.getCofactor(t[0],t[2],t[3],t[8],t[10],t[11],t[12],t[14],t[15]),a=this.getCofactor(t[0],t[1],t[3],t[8],t[9],t[11],t[12],t[13],t[15]),l=this.getCofactor(t[0],t[1],t[2],t[8],t[9],t[10],t[12],t[13],t[14]),u=this.getCofactor(t[1],t[2],t[3],t[5],t[6],t[7],t[13],t[14],t[15]),m=this.getCofactor(t[0],t[2],t[3],t[4],t[6],t[7],t[12],t[14],t[15]),c=this.getCofactor(t[0],t[1],t[3],t[4],t[5],t[7],t[12],t[13],t[15]),d=this.getCofactor(t[0],t[1],t[2],t[4],t[5],t[6],t[12],t[13],t[14]),f=this.getCofactor(t[1],t[2],t[3],t[5],t[6],t[7],t[9],t[10],t[11]),x=this.getCofactor(t[0],t[2],t[3],t[4],t[6],t[7],t[8],t[10],t[11]),g=this.getCofactor(t[0],t[1],t[3],t[4],t[5],t[7],t[8],t[9],t[11]),C=this.getCofactor(t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]);return n=1/n,t[0]=n*i,t[4]=-n*e,t[8]=n*s,t[12]=-n*r,t[1]=-n*o,t[5]=n*h,t[9]=-n*a,t[13]=n*l,t[2]=n*u,t[6]=-n*m,t[10]=n*c,t[14]=-n*d,t[3]=-n*f,t[7]=n*x,t[11]=-n*g,t[15]=n*C,this},invert:function(){return 0==this.m[12]&&0==this.m[13]&&this.m[14]&&1==this.m[15]?this.invertAffine():this.invertGeneral()},multiply:function(t){let i=this.clone();return this.m[0]=i.m[0]*t.m[0]+i.m[4]*t.m[1]+i.m[8]*t.m[2]+i.m[12]*t.m[3],this.m[1]=i.m[1]*t.m[0]+i.m[5]*t.m[1]+i.m[9]*t.m[2]+i.m[13]*t.m[3],this.m[2]=i.m[2]*t.m[0]+i.m[6]*t.m[1]+i.m[10]*t.m[2]+i.m[14]*t.m[3],this.m[3]=i.m[3]*t.m[0]+i.m[7]*t.m[1]+i.m[11]*t.m[2]+i.m[15]*t.m[3],this.m[4]=i.m[0]*t.m[4]+i.m[4]*t.m[5]+i.m[8]*t.m[6]+i.m[12]*t.m[7],this.m[5]=i.m[1]*t.m[4]+i.m[5]*t.m[5]+i.m[9]*t.m[6]+i.m[13]*t.m[7],this.m[6]=i.m[2]*t.m[4]+i.m[6]*t.m[5]+i.m[10]*t.m[6]+i.m[14]*t.m[7],this.m[7]=i.m[3]*t.m[4]+i.m[7]*t.m[5]+i.m[11]*t.m[6]+i.m[15]*t.m[7],this.m[8]=i.m[0]*t.m[8]+i.m[4]*t.m[9]+i.m[8]*t.m[10]+i.m[12]*t.m[11],this.m[9]=i.m[1]*t.m[8]+i.m[5]*t.m[9]+i.m[9]*t.m[10]+i.m[13]*t.m[11],this.m[10]=i.m[2]*t.m[8]+i.m[6]*t.m[9]+i.m[10]*t.m[10]+i.m[14]*t.m[11],this.m[11]=i.m[3]*t.m[8]+i.m[7]*t.m[9]+i.m[11]*t.m[10]+i.m[15]*t.m[11],this.m[12]=i.m[0]*t.m[12]+i.m[4]*t.m[13]+i.m[8]*t.m[14]+i.m[12]*t.m[15],this.m[13]=i.m[1]*t.m[12]+i.m[5]*t.m[13]+i.m[9]*t.m[14]+i.m[13]*t.m[15],this.m[14]=i.m[2]*t.m[12]+i.m[6]*t.m[13]+i.m[10]*t.m[14]+i.m[14]*t.m[15],this.m[15]=i.m[3]*t.m[12]+i.m[7]*t.m[13]+i.m[11]*t.m[14]+i.m[15]*t.m[15],this},scale:function(t,i,e){return this.m[0]*=t,this.m[4]*=t,this.m[8]*=t,this.m[12]*=t,this.m[1]*=i,this.m[5]*=i,this.m[9]*=i,this.m[13]*=i,this.m[2]*=e,this.m[6]*=e,this.m[10]*=e,this.m[14]*=e,this},translate:function(t,i,e){return this.m[0]+=this.m[3]*t,this.m[4]+=this.m[7]*t,this.m[8]+=this.m[11]*t,this.m[12]+=this.m[15]*t,this.m[1]+=this.m[3]*i,this.m[5]+=this.m[7]*i,this.m[9]+=this.m[11]*i,this.m[13]+=this.m[15]*i,this.m[2]+=this.m[3]*e,this.m[6]+=this.m[7]*e,this.m[10]+=this.m[11]*e,this.m[14]+=this.m[15]*e,this},rotate:function(t,i,e,s){let r=this.m[0],n=this.m[1],o=this.m[2],h=this.m[4],a=this.m[5],l=this.m[6],u=this.m[8],m=this.m[9],c=this.m[10],d=this.m[12],f=this.m[13],x=this.m[14],g=Math.sin(t),C=Math.cos(t),A=1-C,S=i*i*A+C,p=i*e*A+s*g,R=i*s*A-e*g,T=i*e*A-s*g,y=e*e*A+C,E=e*s*A+i*g,w=i*s*A+e*g,v=e*s*A-i*g,b=s*s*A+C;return this.m[0]=S*r+T*n+w*o,this.m[1]=p*r+y*n+v*o,this.m[2]=R*r+E*n+b*o,this.m[4]=S*h+T*a+w*l,this.m[5]=p*h+y*a+v*l,this.m[6]=R*h+E*a+b*l,this.m[8]=S*u+T*m+w*c,this.m[9]=p*u+y*m+v*c,this.m[10]=R*u+E*m+b*c,this.m[12]=S*d+T*f+w*x,this.m[13]=p*d+y*f+v*x,this.m[14]=R*d+E*f+b*x,this},rotateX:function(t){let i=this.m[1],e=this.m[2],s=this.m[5],r=this.m[6],n=this.m[9],o=this.m[10],h=this.m[13],a=this.m[14],l=Math.cos(t),u=Math.sin(t);return this.m[1]=i*l+e*-u,this.m[2]=i*u+e*l,this.m[5]=s*l+r*-u,this.m[6]=s*u+r*l,this.m[9]=n*l+o*-u,this.m[10]=n*u+o*l,this.m[13]=h*l+a*-u,this.m[14]=h*u+a*l,this},rotateY:function(t){let i=this.m[0],e=this.m[2],s=this.m[4],r=this.m[6],n=this.m[8],o=this.m[10],h=this.m[12],a=this.m[14],l=Math.cos(t),u=Math.sin(t);return this.m[0]=i*l+e*u,this.m[2]=i*-u+e*l,this.m[4]=s*l+r*u,this.m[6]=s*-u+r*l,this.m[8]=n*l+o*u,this.m[10]=n*-u+o*l,this.m[12]=h*l+a*u,this.m[14]=h*-u+a*l,this},rotateZ:function(t){let i=this.m[0],e=this.m[1],s=this.m[4],r=this.m[5],n=this.m[8],o=this.m[9],h=this.m[12],a=this.m[13],l=Math.cos(t),u=Math.sin(t);return this.m[0]=i*l+e*-u,this.m[1]=i*u+e*l,this.m[4]=s*l+r*-u,this.m[5]=s*u+r*l,this.m[8]=n*l+o*-u,this.m[9]=n*u+o*l,this.m[12]=h*l+a*-u,this.m[13]=h*u+a*l,this},lookAt:function(t,i,e,s,r,n){let o=new Smal.Vector3(t-this.m[12],i-this.m[13],e-this.m[14]);o.normalize();let h=new Smal.Vector3(s||0,r||1,n||0);0==o.x&&0==o.z&&(o.y>0?h.set(0,0,-1):h.set(0,0,1));let a=Smal.Vector3.cross(h,o);return a.normalize(),h=Smal.Vector3.cross(o,a),this.setLeftAxis(a.x,a.y,a.z),this.setUpAxis(h.x,h.y,h.z),this.setForwardAxis(o.x,o.y,o.z),this},transform:function(t){if(t instanceof Smal.Vector4){let i=new Smal.Vector4;return i.x=this.m[0]*t.x+this.m[4]*t.y+this.m[8]*t.z+this.m[12]*t.w,i.y=this.m[1]*t.x+this.m[5]*t.y+this.m[9]*t.z+this.m[13]*t.w,i.z=this.m[2]*t.x+this.m[6]*t.y+this.m[10]*t.z+this.m[14]*t.w,i.w=this.m[3]*t.x+this.m[7]*t.y+this.m[11]*t.z+this.m[15]*t.w,i}if(t instanceof Smal.Vector3){let i=new Smal.Vector3;return i.x=this.m[0]*t.x+this.m[4]*t.y+this.m[8]*t.z+1*this.m[12],i.y=this.m[1]*t.x+this.m[5]*t.y+this.m[9]*t.z+1*this.m[13],i.z=this.m[2]*t.x+this.m[6]*t.y+this.m[10]*t.z+1*this.m[14],i}return null},toString:function(){return"===== Matrix4 =====\n| "+this.m[0].toFixed(3)+" "+this.m[4].toFixed(3)+" "+this.m[8].toFixed(3)+" "+this.m[12].toFixed(3)+" |\n| "+this.m[1].toFixed(3)+" "+this.m[5].toFixed(3)+" "+this.m[9].toFixed(3)+" "+this.m[13].toFixed(3)+" |\n| "+this.m[2].toFixed(3)+" "+this.m[6].toFixed(3)+" "+this.m[10].toFixed(3)+" "+this.m[14].toFixed(3)+" |\n| "+this.m[3].toFixed(3)+" "+this.m[7].toFixed(3)+" "+this.m[11].toFixed(3)+" "+this.m[15].toFixed(3)+" |\n"}},Smal.Matrix4.lookat=function(t,i,e){let s=new Smal.Vector3(i.x-t.x,i.y-t.y,i.z-t.z);s.normalize();let r=Smal.Vector3.cross(e,s).normalize(),n=Smal.Vector3.cross(s,r).normalize();return new Smal.Matrix4(r.x,n.x,s.x,0,r.y,n.y,s.y,0,r.z,n.z,s.z,0,0,0,0,1)},Smal.Matrix4.makeFrustum=function(t,i,e,s,r,n){let o=new Smal.Matrix4;return o.m[0]=2*r/(i-t),o.m[5]=2*r/(s-e),o.m[8]=(i+t)/(i-t),o.m[9]=(s+e)/(s-e),o.m[10]=-(n+r)/(n-r),o.m[11]=-1,o.m[14]=-2*n*r/(n-r),o.m[15]=0,o},Smal.Matrix4.makeOrthographic=function(t,i,e,s,r,n){let o=new Smal.Matrix4;return o.m[0]=2/(i-t),o.m[5]=2/(s-e),o.m[10]=-2/(n-r),o.m[12]=-(i+t)/(i-t),o.m[13]=-(s+e)/(s-e),o.m[14]=-(n+r)/(n-r),o},Smal.Matrix4.makePerspective=function(t,i,e,s){let r=e*Math.tan(t/2*Math.PI/180),n=r*i;return Smal.Matrix4.makeFrustum(-n,n,-r,r,e,s)},Smal.Quaternion=function(t=0,i=0,e=0,s=0){this.s=t,this.x=i,this.y=e,this.z=s},Smal.Quaternion.prototype={set:function(t=0,i=0,e=0,s=0){return t instanceof Smal.Quaternion?(this.s=t.s,this.x=t.x,this.y=t.y,this.z=t.z):t instanceof Smal.Vector3?(this.s=0,this.x=t.x,this.y=t.y,this.z=t.z):(this.s=t,this.x=i,this.y=e,this.z=s),this},setWithAxisAngle:function(t,i){let e=new Smal.Vector3(t.x,t.y,t.z);e.normalize();let s=Math.sin(i);return this.s=Math.cos(i),this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this},add:function(t){return this.s+=t.s,this.x+=t.x,this.y+=t.y,this.z+=t.z,this},substract:function(t){return this.s-=t.s,this.x-=t.x,this.y-=t.y,this.z-=t.z,this},multiply:function(t){let i=new Smal.Vector3(this.x,this.y,this.z),e=new Smal.Vector3(t.x,t.y,t.z),s=this.s*t.s-i.dot(e),r=Smal.Vector3.cross(i,e);return r.add(e.scale(this.s)),r.add(i.scale(t.s)),this.set(s,r.x,r.y,r.z),this},scale:function(t){return this.s*=t,this.x*=t,this.y*=t,this.z*=t,this},length:function(){return Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){let t=this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z;if(t<1e-5)return this;let i=1/Math.sqrt(t);return this.s*=i,this.x*=i,this.y*=i,this.z*=i,this},conjugate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},invert:function(){let t=this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z;if(t<1e-5)return this;let i=new Smal.Quaternion(this.s,this.x,this.y,this.z);return i.conjugate().scale(1/t),this.set(i.s,i.x,i.y,i.z),this},toMatrix:function(){let t=this.x+this.x,i=this.y+this.y,e=this.z+this.z,s=this.x*t,r=this.x*i,n=this.x*e,o=this.y*i,h=this.y*e,a=this.z*e,l=this.s*t,u=this.s*i,m=this.s*e;return new Smal.Matrix4(1-(o+a),r+m,n-u,0,r-m,1-(s+a),h+l,0,n+u,h-l,1-(s+o),0,0,0,0,1)},clone:function(){return new Smal.Quaternion(this.s,this.x,this.y,this.z)},toString:function(){return"Quaternion("+Math.round(1e5*this.s)/1e5+", "+Math.round(1e5*this.x)/1e5+", "+Math.round(1e5*this.y)/1e5+", "+Math.round(1e5*this.z)/1e5+")"}},Smal.Quaternion.toQuaternion=function(t,i){const e=.5*Math.PI;let s=new Smal.Quaternion,r=new Smal.Vector3;if(Math.abs(t.x-i.x)<.001&&Math.abs(t.y-i.y)<.001&&Math.abs(t.z-i.z)<.001)return s.setWithAxisAngle(t,0);if(Math.abs(t.x+i.x)<.001&&Math.abs(t.y+i.y)<.001&&Math.abs(t.z+i.z)<.001)return t.x>-.001&&t.x<.001?r.set(1,0,0):t.y>-.001&&t.y<.001?r.set(0,1,0):r.set(0,0,1),s.setWithAxisAngle(r,e);let n=t.clone().normalize(),o=i.clone().normalize();r=Smal.Vector3.cross(n,o);let h=Math.acos(n.dot(o));return s.setWithAxisAngle(r,.5*h),s},Smal.Quaternion.toQuaternionFromAngles=function(t,i,e){let s=new Smal.Quaternion(1,0,0,0);if(e&&s.setWithAxisAngle(new Smal.Vector3(0,0,1),e),i){let t=new Smal.Quaternion(1,0,0,0);t.setWithAxisAngle(new Smal.Vector3(0,1,0),i),s=t.multiply(s)}if(t){let i=new Smal.Quaternion(1,0,0,0);i.setWithAxisAngle(new Smal.Vector3(1,0,0),t),s=i.multiply(s)}return s},Smal.Quaternion.slerp=function(t,i,e,s){let r=Smal.getInterpolateAlpha(e,s),n=t.s*i.s+t.x*i.x+t.y*i.y+t.z*i.z;if(n<0&&(n=-n,t.scale(-1)),n>.999){let e=new Smal.Quaternion;return e.s=t.s+r*(i.s-t.s),e.x=t.x+r*(i.x-t.x),e.y=t.y+r*(i.y-t.y),e.z=t.z+r*(i.z-t.z),e}if(n<-.999){let i=t.clone();i.normalize();let e=new Smal.Vector3;Math.fab(t.x)<.001?e.set(1,0,0):e.set(0,1,0);let s=Smal.Vector3.cross(i,e);s.normalize();let o=Math.acos(n)*r,h=new Smal.Quaternion;return h.s=0,h.x=i.x+Math.cos(o)+s.x*Math.sin(o),h.y=i.y+Math.cos(o)+s.y*Math.sin(o),h.z=i.z+Math.cos(o)+s.z*Math.sin(o),new h}let o=Math.acos(n),h=1/Math.sqrt(1-n*n),a=Math.sin((1-r)*o)*h,l=Math.sin(r*o)*h,u=new Smal.Quaternion;return u.s=t.s*a+i.s*l,u.x=t.x*a+i.x*l,u.y=t.y*a+i.y*l,u.z=t.z*a+i.z*l,u},Smal.Light=function(t,i,e,s){this.position=new Smal.Vector4(t,i,e,s),this.color=new Smal.Vector4(1,1,1,1),this.attenuations=new Smal.Vector3(1,0,0)},Smal.Light.prototype={getPosition:function(){return new Float32Array([this.position.x,this.position.y,this.position.z,this.position.w])},setPosition:function(t,i,e,s){return this.position.set(t,i,e,s),this},getColor:function(){return new Float32Array([this.color.x,this.color.y,this.color.z,this.color.w])},setColor:function(t,i,e,s){return this.color.set(t,i,e,s),this},getAttenuations:function(){return new Float32Array([this.attenuations.x,this.attenuations.y,this.attenuations.z])},setAttenuations:function(t,i,e){return this.attenuations.set(t,i,e),this},toString:function(){return"===== Light =====\n    Position: "+this.position+"\n       Color: "+this.color+"\nAttenuations: "+this.attenuations+"\n"}},Smal.Material=function(t,i,e,s){this.ambient=new Smal.Vector4(0,0,0,0),this.diffuse=new Smal.Vector4(t,i,e,s),this.specular=new Smal.Vector4(1,1,1,1),this.shininess=0},Smal.Material.prototype={getAmbient:function(){return new Float32Array([this.ambient.x,this.ambient.y,this.ambient.z,this.ambient.w])},getDiffuse:function(){return new Float32Array([this.diffuse.x,this.diffuse.y,this.diffuse.z,this.diffuse.w])},getSpecular:function(){return new Float32Array([this.specular.x,this.specular.y,this.specular.z,this.specular.w])},setAmbient:function(t,i,e,s){return this.ambient.set(t,i,e,s),this},setDiffuse:function(t,i,e,s){return this.diffuse.set(t,i,e,s),this},setSpecular:function(t,i,e,s){return this.specular.set(t,i,e,s),this},toString:function(){return"===== Material =====\n  Ambient: ("+this.ambient.x+", "+this.ambient.y+", "+this.ambient.z+", "+this.ambient.w+")\n  Diffuse: ("+this.diffuse.x+", "+this.diffuse.y+", "+this.diffuse.z+", "+this.diffuse.w+")\n Specular: ("+this.specular.x+", "+this.specular.y+", "+this.specular.z+", "+this.specular.w+")\nShininess: "+this.shininess+"\n"}},Smal.Timer=function(){this.startTime=0,this.endTime=0,this.prevTime=0,this.stopped=!0},Smal.Timer.prototype={start:function(){this.startTime=this.endTime=Date.now(),this.prevTime=this.startTime,this.stopped=!1},stop:function(){this.endTime=Date.now(),this.prevTime=0,this.stopped=!0},getTime:function(){return this.stopped||(this.endTime=Date.now()),this.endTime-this.startTime},getFrameTime:function(){if(0==this.prevTime)return 0;let t=Date.now(),i=t-this.prevTime;return this.prevTime=t,i}},Smal.FrameRate=function(t){let i=document.getElementById(t);this.textNode=i?i.childNodes[0]:null,this.frameCount=0,this.startTime=Date.now();let e=this;this.intervalId=setInterval(function(){e.print()},1e3)},Smal.FrameRate.prototype={print:function(){if(!this.textNode)return;let t=1e3*this.frameCount/(Date.now()-this.startTime);this.textNode.nodeValue=t.toFixed(1)+" FPS",this.startTime=Date.now(),this.frameCount=0},toString:function(){return"FrameRate("+(1e3*this.frameCount/(Date.now()-this.startTime)).toFixed(1)+" FPS)"},tick:function(){this.frameCount++},setUpdateInterval:function(t){clearInterval(this.intervalId);let i=this;return this.intervalId=setInterval(function(){i.print()},t),this}},Smal.MouseState=function(){this.x=0,this.y=0,this.downX=0,this.downY=0,this.leftDown=!1,this.middleDown=!1,this.rightDown=!1},Smal.MouseState.prototype={toString:function(){let t="";return this.leftDown&&(t+="Left "),this.middleDown&&(t+="Middle "),this.rightDown&&(t+="Right"),"Position: ("+this.x+", "+this.y+"),  Button: "+t}},Smal.Trackball=function(t=0,i=0,e=0){this.radius=t,this.screenWidth=i,this.screenHeight=e},Smal.Trackball.prototype={set:function(t,i,e){return this.radius=t,this.screenWidth=i,this.screenHeight=e,this},setRadius:function(t){return this.radius=t,this},setScreenSize:function(t,i){return this.screenWidth=t,this.screenHeight=i,this},getVector:function(t,i){let e=new Smal.Vector3(0,0,0);if(0==this.radius||0==this.screenWidth||0==this.screenHeight)return e;e.x=t-.5*this.screenWidth,e.y=.5*this.screenHeight-i;let s=e.x*e.x+e.y*e.y,r=this.radius*this.radius;if(s<=.5*r)e.z=Math.sqrt(r-s);else{let t,i,n;e.z=.5*r/Math.sqrt(s),0==e.x?(t=0,i=Math.sqrt(r-e.z*e.z),e.y<0&&(i=-i)):(n=e.y/e.x,t=Math.sqrt((r-e.z*e.z)/(1+n*n)),e.x<0&&(t=-t),i=n*t),e.x=t,e.y=i}return e},getUnitVector:function(t,i){return this.getVector(t,i).normalize()},toString:function(){return"===== Trackball =====\n     Radius: "+this.radius+"\nScreen Size: ("+this.screenWidth+", "+this.screenHeight+")\n"}},Smal.Camera=function(t,i,e){this.position=new Smal.Vector3(t,i,e),this.target=new Smal.Vector3(0,0,0),this.distance=this.position.distance(this.target),this.offset=new Smal.Vector2(0,0),this.quaternion=new Smal.Quaternion(1,0,0,0),this.matrix=new Smal.Matrix4,this.maxMoveSpeed=1,this.maxTurnSpeed=1,this.maxZoomSpped=1,this.moveAccel=1,this.turnAccel=1,this.zoomAccel=1,this.shifting=!1,this.shiftTime=0,this.shiftSpeed=0,this.shiftVector=new Smal.Vector2(0,0),this.zooming=!1,this.zoomTime=0,this.zoomSpeed=0,this.zoomDir=0},Smal.Camera.prototype={update:function(){return this.matrix.identity(),this.matrix.translate(-this.target.x,-this.target.y,-this.target.z),this.matrix=this.quaternion.toMatrix().multiply(this.matrix),this.matrix.translate(-this.offset.x,-this.offset.y,-this.distance),this.matrix},moveTo:function(t,i,e,s){i||(i=0),e||(e=Smal.AnimationMode.LINEAR),s=s||function(){};let r=Smal.getRequestAnimationFrameFunction(window),n=Date.now(),o=n+i,h=this.target.clone(),a=this;return r(function i(){let l=Date.now();let u=(l-n)/(o-n);if(l>=o)return a.target.set(t.x,t.y,t.z),a.update(),void s();a.target=Smal.Vector3.interpolate(h,t,u,e);a.update();r(i)}),this},moveDistanceTo:function(t,i,e,s){i||(i=0),e||(e=Smal.AnimationMode.LINEAR),s=s||function(){};let r=Smal.getRequestAnimationFrameFunction(window),n=Date.now(),o=n+i,h=this.distance,a=this;return r(function i(){let l=Date.now();let u=(l-n)/(o-n);if(l>=o)return a.distance=t,a.update(),void s();u=Smal.getInterpolateAlpha(u,e);a.distance=h+(t-h)*u;a.update();r(i)}),this},rotateTo:function(t,i,e,s){i||(i=0),s=s||function(){};let r=Smal.getRequestAnimationFrameFunction(window),n=Date.now(),o=n+i,h=this.quaternion.clone(),a=this;return r(function i(){let l=Date.now();let u=(l-n)/(o-n);u=Smal.getInterpolateAlpha(u,e);if(l>=o)return a.quaternion.set(t.s,t.x,t.y,t.z),a.update(),void s();a.quaternion=Smal.Quaternion.slerp(h,t,u);a.update();r(i)}),this},shiftTo:function(t,i,e,s){i||(i=0),e||(e=Smal.AnimationMode.LINEAR),s=s||function(){};let r=Smal.getRequestAnimationFrameFunction(window),n=Date.now(),o=n+i,h=this.offset.clone(),a=this;return r(function i(){let l=Date.now();let u=(l-n)/(o-n);if(l>=o)return a.offset.set(t.x,t.y),a.update(),void s();a.offset=Smal.Vector2.interpolate(h,t,u,e);a.update();r(i)}),this},setMoveSpeed:function(t){return this.maxMoveSpeed=t,this},setRotateSpeed:function(t){return this.maxTurnSpeed=t,this},setMoveAcceleration:function(t){return this.moveAccel=t,this},setRotateAcceleration:function(t){return this.turnAccel=t,this},setZoomSpeed:function(t){return this.maxZoomSpeed=t,this},setZoomAcceleration:function(t){return this.zoomAccel=t,this},startShift:function(t){switch(t.toLowerCase()){case"left":this.shiftVector.set(1,0);break;case"right":this.shiftVector.set(-1,0);break;case"up":this.shiftVector.set(0,-1);break;case"down":this.shiftVector.set(0,1);break;default:return this.shiftVector.set(0,0),void log("[WARNING] "+t+" is an invalid direction in Smal.Camera.startShift().")}this.shifting=!0,this.shiftTime=Date.now(),this.shiftSpeed=0;let i=this;return Smal.getRequestAnimationFrameFunction(window)(function(){Smal.Camera.shiftCallback(i)}),this},stopShift:function(){return this.shifting=!1,this},startZoom:function(t){this.zooming=!0,this.zoomDir=t,this.zoomSpeed=0,this.zoomTime=Date.now();let i=this;return Smal.getRequestAnimationFrameFunction(window)(function(){Smal.Camera.zoomCallback(i)}),this},startZoomIn:function(){this.zooming=!0,this.zoomDir=-1,this.zoomSpeed=0,this.zoomTime=Date.now();let t=this;return Smal.getRequestAnimationFrameFunction(window)(function(){Smal.Camera.zoomCallback(t)}),this},startZoomOut:function(){this.zooming=!0,this.zoomDir=1,this.zoomSpeed=0,this.zoomTime=Date.now();let t=this;return Smal.getRequestAnimationFrameFunction(window)(function(){Smal.Camera.zoomCallback(t)}),this},stopZoom:function(){return this.zooming=!1,this},setPosition:function(t,i,e){return this.position.set(t,i,e),this},setTarget:function(t,i,e){return this.target.set(t,i,e),this},setOffset:function(t,i){return this.offset.set(t,i),this},setQuaternion:function(t,i,e,s){return this.quaternion.set(t,i,e,s),this},toString:function(){return"===== Camera =====\n  Position: "+this.position+"\n    Target: "+this.target+"\n    Offset: "+this.offset+"\n  Distance: "+Math.round(1e5*this.distance)/1e5+"\nQuaternion: "+Math.round(1e5*this.quaternion)/1e5+"\n"}},Smal.Camera.shiftCallback=function(t){let i=Date.now(),e=.001*(i-t.shiftTime);if(t.shiftTime=i,t.shiftSpeed=Smal.adjustSpeed(t.shifting,t.shiftSpeed,t.maxMoveSpeed,t.moveAccel,e),t.offset.x+=e*t.shiftSpeed*t.shiftVector.x,t.offset.y+=e*t.shiftSpeed*t.shiftVector.y,t.update(),t.shifting||t.shiftSpeed>0){Smal.getRequestAnimationFrameFunction(window)(function(){Smal.Camera.shiftCallback(t)})}},Smal.Camera.zoomCallback=function(t){let i=Date.now(),e=.001*(i-t.zoomTime);if(t.zoomTime=i,t.zoomSpeed=Smal.adjustSpeed(t.zooming,t.zoomSpeed,t.maxZoomSpeed,t.zoomAccel,e),t.distance+=e*t.zoomSpeed*t.zoomDir,t.update(),t.zooming||t.zoomSpeed>0){Smal.getRequestAnimationFrameFunction(window)(function(){Smal.Camera.zoomCallback(t)})}},Smal.OrbitCamera=function(t,i,e,s,r,n){this.position=new Smal.Vector3(0,0,0),this.target=new Smal.Vector3(0,0,0),this.distance=0,this.angle=new Smal.Vector3(0,0,0),this.quaternion=new Smal.Quaternion(1,0,0,0),this.matrix=new Smal.Matrix4,this.matrixRotation=new Smal.Matrix4,this.lookAt(t,i,e,s,r,n),this.moving=!1,this.movingId=0,this.movingTime=0,this.movingFrom=new Smal.Vector3,this.movingTo=new Smal.Vector3,this.rotating=!1,this.rotatingId=0,this.rotatingTime=0,this.rotatingDuration=0,this.rotatingFrom=new Smal.Quaternion(1,0,0,0),this.rotatingTo=new Smal.Quaternion(1,0,0,0),this.rotatingAngleFrom=new Smal.Vector3,this.rotatingAngleTo=new Smal.Vector3,this.rotatingSpeed=0,this.rotatingAccel=0,this.rotatingMaxSpeed=0,this.rotatingCallback,this.forwarding=!1,this.forwardingId=0,this.forwardingTime=0,this.forwardingDuration=0,this.forwardingFrom=0,this.forwardingTo=0,this.forwardingSpeed=0,this.forwardingAccel=0,this.forwardingMaxSpeed=0,this.forwardingCallback,this.shifting=!1,this.shiftingId=0,this.shiftingTime=0,this.shiftingDuration=0,this.shiftingFrom=new Smal.Vector3,this.shiftingTo=new Smal.Vector3,this.shiftingVector=new Smal.Vector3,this.shiftingSpeed=0,this.shiftingAccel=0,this.shiftingMaxSpeed=0,this.shiftingCallback},Smal.OrbitCamera.prototype={update:function(){let t=this.matrixRotation.getLeftAxis(),i=this.matrixRotation.getUpAxis(),e=this.matrixRotation.getForwardAxis(),s=new Smal.Vector3(t.x*-this.target.x+i.x*-this.target.y+e.x*-this.target.z,t.y*-this.target.x+i.y*-this.target.y+e.y*-this.target.z,t.z*-this.target.x+i.z*-this.target.y+e.z*-this.target.z-this.distance);return this.matrix.identity(),this.matrix.setColumn(0,t),this.matrix.setColumn(1,i),this.matrix.setColumn(2,e),this.matrix.setColumn(3,s),this.computePosition(),this.matrix},lookAt:function(t=0,i=0,e=0,s=0,r=0,n=0){if(this.position.set(t,i,e),this.target.set(s,r,n),t==s&&i==r&&e==n)return this.matrix.identity(),this.matrix.setColumn(3,new Smal.Vector3(-t,-i,-e)),this.matrixRotation.identity(),this.angle.set(0,0,0),void this.quaternion.set(1,0,0,0);let o=this.position.clone().subtract(this.target);this.distance=o.length(),o.scale(1/this.distance);let h=new Smal.Vector3(0,1,0);Math.abs(o.x)<1e-5&&Math.abs(o.z)<1e-5&&(o.y>0?h.set(0,0,-1):h.set(0,0,1));let a=Smal.Vector3.cross(h,o);a.normalize(),h=Smal.Vector3.cross(o,a),this.matrixRotation.identity(),this.matrixRotation.setRow(0,a),this.matrixRotation.setRow(1,h),this.matrixRotation.setRow(2,o),this.matrix.identity(),this.matrix.setRow(0,a),this.matrix.setRow(1,h),this.matrix.setRow(2,o);let l=new Smal.Vector3;l.x=this.matrix.m[0]*-t+this.matrix.m[4]*-i+this.matrix.m[8]*-e,l.y=this.matrix.m[1]*-t+this.matrix.m[5]*-i+this.matrix.m[9]*-e,l.z=this.matrix.m[2]*-t+this.matrix.m[6]*-i+this.matrix.m[10]*-e,this.matrix.setColumn(3,l);let u=this.matrixRotation.getAngle();return this.quaternion=Smal.Quaternion.toQuaternionFromAngles(.5*u.x,.5*u.y,.5*u.z),this.angle.x=Smal.rad2deg(u.x),this.angle.y=Smal.rad2deg(-u.y),this.angle.z=Smal.rad2deg(u.z),this},moveTo:function(t,i,e,s){if(!i||i<=0)return void this.setPosition(t);if(e=e||Smal.AnimationMode.EASE_OUT,s=s||function(){},0!=this.movingId){Smal.getCancelAnimationFrameFunction(window)(this.movingId),this.movingId=0}this.movingTime=Date.now(),this.movingDuration=i,this.movingFrom.set(this.position),this.movingTo.set(t);let r=this,n=Smal.getRequestAnimationFrameFunction(window);return this.movingId=n(function t(){let i=Date.now();if(i>=r.movingTime+r.movingDuration)return r.setPosition(r.movingTo),r.movingId=0,void s(r);let o=(i-r.movingTime)/r.movingDuration;let h=Smal.Vector3.interpolate(r.movingFrom,r.movingTo,o,e);r.setPosition(h);r.movingId=n(t)}),this},moveForward:function(t,i,e,s){if(!i||i<=0)return void this.setDistance(this.distance-t);e=e||Smal.AnimationMode.EASE_OUT,s=s||function(){},0!=this.forwardingId&&this.stopForward();let r=this;this.forwarding=!0,this.forwardingFrom=this.distance,this.forwardingTo=this.distance-t,this.forwardingTime=Date.now(),this.forwardingDuration=i;let n=Smal.getRequestAnimationFrameFunction(window);return this.forwardingId=n(function t(){let i=Date.now();if(i>=r.forwardingTime+r.forwardingDuration)return r.setDistance(r.forwardingTo),r.forwardingId=0,r.forwarding=!1,void s(r);let o=(i-r.forwardingTime)/r.forwardingDuration;let h=Smal.interpolate(r.forwardingFrom,r.forwardingTo,o,e);r.setDistance(h);r.forwardingId=n(t)}),this},startForward:function(t,i){if(this.forwarding)return this.forwardingMaxSpeed=t,void(this.forwardingAccel=i);let e=this;return this.forwarding=!0,this.forwardingSpeed=0,this.forwardingMaxSpeed=t,this.forwardingAccel=i,this.forwardingTime=Date.now(),Smal.getRequestAnimationFrameFunction(window)(function(){Smal.OrbitCamera.forwardCallback(e)}),this},stopForward:function(t){if(this.forwarding=!1,this.forwardingCallback=t||function(){},0!=this.forwardingId){Smal.getCancelAnimationFrameFunction(window)(this.forwardingId),this.forwardingId=0}return this},shiftTo:function(t,i,e,s){if(!i||i<=0)return void this.setTarget(t);e=e||Smal.AnimationMode.EASE_OUT,s=s||function(){},0!=this.shiftingId?(this.stopShift(),this.shiftingDuration=i+(Date.now()-this.shiftingTime)):(this.shiftingTime=Date.now(),this.shiftingDuration=i),this.shifting=!0,this.shiftingFrom.set(this.target),this.shiftingTo.set(t);let r=this,n=Smal.getRequestAnimationFrameFunction(window);return this.shiftingId=n(function t(){let i=Date.now();if(i>=r.shiftingTime+r.shiftingDuration)return r.setTarget(r.shiftingTo),r.shiftingId=0,r.shifting=!1,void s(r);let o=(i-r.shiftingTime)/r.shiftingDuration;let h=Smal.Vector3.interpolate(r.shiftingFrom,r.shiftingTo,o,e);r.setTarget(h);r.shiftingId=n(t)}),this},shift:function(t,i,e,s){let r=new Smal.Vector3(-this.matrix.m[0],-this.matrix.m[4],-this.matrix.m[8]),n=new Smal.Vector3(-this.matrix.m[1],-this.matrix.m[5],-this.matrix.m[9]),o=r.clone().scale(t.x);return o.add(n.clone().scale(-t.y)),o.add(this.target),this.shiftTo(o,i,e),this},startShift:function(t,i){let e=new Smal.Vector3(-this.matrix.m[0],-this.matrix.m[4],-this.matrix.m[8]),s=new Smal.Vector3(-this.matrix.m[1],-this.matrix.m[5],-this.matrix.m[9]),r=e.clone().scale(t.x);if(r.add(s.clone().scale(-t.y)),r.normalize(),this.shifting)return this.shiftingVector.set(r),this.shiftingMaxSpeed=t.length(),void(this.shiftingAccel=i);let n=this;return this.shifting=!0,this.shiftingVector=r,this.shiftingSpeed=0,this.shiftingMaxSpeed=t.length(),this.shiftingAccel=i,this.shiftingTime=Date.now(),Smal.getRequestAnimationFrameFunction(window)(function(){Smal.OrbitCamera.shiftCallback(n)}),this},stopShift:function(t){if(this.shifting=!1,this.shiftingCallback=t||function(){},0!=this.shiftingId){Smal.getCancelAnimationFrameFunction(window)(this.shiftingId),this.shiftingId=0}return this},rotateTo:function(t,i,e,s){return t instanceof Smal.Quaternion?this.rotateToByQuaternion(t,i,e,s):this.rotateToByAngle(t,i,e,s),this},rotateToByQuaternion:function(t,i,e,s){if(!i||i<=0)return void this.setRotationByQuaternion(t);e=e||Smal.AnimationMode.EASE_OUT,s=s||function(){},this.rotating?(this.stopRotate(),this.rotatingDuration=i+(Date.now()-this.rotatingTime)):(this.rotatingTime=Date.now(),this.rotatingDuration=i),this.rotating=!0,this.rotatingFrom.set(this.quaternion),this.rotatingTo.set(t);let r=Smal.getRequestAnimationFrameFunction(window);this.rotatingId=r(function t(){let i=Date.now();if(i>=n.rotatingTime+n.rotatingDuration)return n.setRotationByQuaternion(n.rotatingTo),n.rotatingId=0,n.rotating=!1,void s(n);let o=(i-n.rotatingTime)/n.rotatingDuration;let h=Smal.Quaternion.slerp(n.rotatingFrom,n.rotatingTo,o,e);n.setRotationByQuaternion(h);n.rotatingId=r(t)});let n=this;return this},rotateToByAngle:function(t,i,e,s){if(!i||i<=0)return void this.setRotationByAngle(t);e=e||Smal.AnimationMode.EASE_OUT,s=s||function(){},this.rotating?(this.stopRotate(),this.rotatingDuration=i+(Date.now()-this.rotatingTime)):(this.rotatingTime=Date.now(),this.rotatingDuration=i),this.rotating=!0,this.rotatingAngleFrom.set(this.angle),this.rotatingAngleTo.set(t);let r=Smal.getRequestAnimationFrameFunction(window);this.rotatingId=r(function t(){let i=Date.now();if(i>=n.rotatingTime+n.rotatingDuration)return n.setRotationByAngle(n.rotatingAngleTo),n.rotatingId=0,n.rotating=!1,void s(n);let o=(i-n.rotatingTime)/n.rotatingDuration;let h=n.rotatingAngleTo.clone();let a=n.rotatingAngleTo.clone().subtract(n.rotatingAngleFrom);a.x>180?h.x-=360:a.x<-180&&(h.x+=360);a.y>180?h.y-=360:a.y<-180&&(h.y+=360);a.z>180?h.z-=360:a.z<-180&&(h.z+=360);let l=Smal.Vector3.interpolate(n.rotatingAngleFrom,h,o,e);n.setRotationByAngle(l);n.rotatingId=r(t)});let n=this;return this},startRotate:function(t){return Smal.Quaternion,this},stopRotate:function(t){if(this.rotating=!1,this.rotatingCallback=t||function(){},0!=this.rotatingId){Smal.getCancelAnimationFrameFunction(window)(this.rotatingId),this.rotatingId=0}return this},setRotationByAngle:function(t){let i,e,s,r,n,o,h=new Smal.Vector3(t.x,t.y,t.z);return h.x=Smal.normalizeDegree(t.x),h.y=Smal.normalizeDegree(t.y),h.z=Smal.normalizeDegree(t.z),this.angle.set(h),h.x=Smal.deg2rad(h.x),h.y=Smal.deg2rad(h.y),h.z=Smal.deg2rad(h.z),this.quaternion=Smal.Quaternion.toQuaternionFromAngles(h.x,-h.y,h.z),i=Math.sin(h.x),r=Math.cos(h.x),e=Math.sin(-h.y),n=Math.cos(-h.y),s=Math.sin(h.z),o=Math.cos(h.z),this.matrixRotation.setLeftAxis(n*o,i*e*o+r*s,-r*e*o+i*s),this.matrixRotation.setUpAxis(-n*s,-i*e*s+r*o,r*e*s+i*o),this.matrixRotation.setForwardAxis(e,-i*n,r*n),this.update(),this},setRotationByQuaternion:function(t){this.quaternion.set(t),this.matrixRotation=t.toMatrix();let i=this.matrixRotation.getAngle();return this.angle.x=Smal.rad2deg(i.x),this.angle.y=Smal.rad2deg(-i.y),this.angle.z=Smal.rad2deg(i.z),this.update(),this},setPosition:function(t,i,e){return t instanceof Smal.Vector3?this.lookAt(t.x,t.y,t.z,this.target.x,this.target.y,this.target.z):this.lookAt(t,i,e,this.target.x,this.target.y,this.target.z),this},setTarget:function(t,i,e){return t instanceof Smal.Vector3?this.target.set(t.x,t.y,t.z):this.target.set(t,i,e),this.update(),this},setDistance:function(t){return this.distance=t,this.update(),this},setOffset:function(t,i){return this.offset.set(t,i),this},setQuaternion:function(t,i,e,s){return this.quaternion.set(t,i,e,s),this},computePosition:function(){this.position.x=this.target.x-this.distance*-this.matrix.m[2],this.position.y=this.target.y-this.distance*-this.matrix.m[6],this.position.z=this.target.z-this.distance*-this.matrix.m[10]},isAnimating:function(){return this.moving||this.rotating||this.forwarding||this.forwardingSpeed||this.shifting||this.shiftingSpeed},toString:function(){return"===== OrbitCamera =====\n  Position: "+this.position+"\n    Target: "+this.target+"\n  Distance: "+this.distance+"\n     Angle: "+this.angle+"\nQuaternion: "+this.quaternion+"\n"}},Smal.OrbitCamera.shiftCallback=function(t){let i=Date.now(),e=.001*(i-t.shiftingTime);t.shiftingTime=i,t.shiftingSpeed=Smal.adjustSpeed(t.shifting,t.shiftingSpeed,t.shiftingMaxSpeed,t.shiftingAccel,e);let s=t.shiftingSpeed*e,r=new Smal.Vector3;if(r.x=t.target.x+t.shiftingVector.x*s,r.y=t.target.y+t.shiftingVector.y*s,r.z=t.target.z+t.shiftingVector.z*s,t.setTarget(r),t.shifting||t.shiftingSpeed>0){Smal.getRequestAnimationFrameFunction(window)(function(){Smal.OrbitCamera.shiftCallback(t)})}else t.shifting||0!=t.shiftingSpeed||t.shiftingCallback(t)},Smal.OrbitCamera.forwardCallback=function(t){let i=Date.now(),e=.001*(i-t.forwardingTime);if(t.forwardingTime=i,t.forwardingSpeed=Smal.adjustSpeed(t.forwarding,t.forwardingSpeed,t.forwardingMaxSpeed,t.forwardingAccel,e),t.setDistance(t.distance-t.forwardingSpeed*e),t.update(),t.forwarding||0!=t.forwardingSpeed){Smal.getRequestAnimationFrameFunction(window)(function(){Smal.OrbitCamera.forwardCallback(t)})}else t.forwarding||0!=t.forwardingSpeed||t.forwardingCallback(t)},Smal.OrbitCamera.rotateCallback=function(){},Smal.SelectBuffer=function(t){this.gl=t,t||log("[ERROR] Smal.SelectBuffer.contructor requires GL context as a param."),this.fbo=null,this.rbo=null,this.tex=null,this.invalid=!0},Smal.SelectBuffer.prototype={init:function(t,i){let e=this.gl;this.fbo&&e.deleteFramebuffer(this.fbo),this.rbo&&e.deleteRenderbuffer(this.rbo),this.tex&&e.deleteTexture(this.tex),this.invalid=!0,this.fbo=e.createFramebuffer(),this.rbo=e.createRenderbuffer(),this.tex=e.createTexture(),e.bindFramebuffer(e.FRAMEBUFFER,this.fbo),e.bindRenderbuffer(e.RENDERBUFFER,this.rbo),e.bindTexture(e.TEXTURE_2D,this.tex);try{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,null)}catch(s){let r=new WebGLUnsignedByteArray(t*i*4);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,r)}e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.tex,0),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.rbo);let s=e.checkFramebufferStatus(e.FRAMEBUFFER),r=!1;switch(s){case e.FRAMEBUFFER_COMPLETE:r=!0;break;case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"SelectBuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"SelectBuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"SelectBuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case e.FRAMEBUFFER_UNSUPPORTED:throw"SelectBuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"SelectBuffer: "+s}return e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null),r},bind:function(){return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo),this},unbind:function(){return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this},clear:function(){return this.bind(),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.unbind(),this},pick:function(t,i){this.bind();let e=new Uint8Array(4);return this.gl.readPixels(t,i,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.unbind(),e[0]+(e[1]<<8)+(e[2]<<16)},getColor:function(t){return new Float32Array([(255&t)/255,(t>>8&255)/255,(t>>16&255)/255,1])}};let ConfigItem=function(){this.id=null,this.args={}};Smal.ConfigManager=function(){this.items=[]},Smal.ConfigManager.prototype={read:function(t,i){let e=this;i=i||function(){};let s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="text",s.send(),s.onload=function(){200==s.status?(e.parse(s.response),i(e)):(log("[ERROR] Failed to read file("+s.status+"): "+t),i(!1))}},parse:function(t){this.items.length=0;let i,e=-1,s=t.split(/\r\n|\r|\n/);for(let t=0,r=s.length;t<r;++t){if("#"==(i=s[t]).charAt(0))continue;if("["==i.charAt(0)){let t=new ConfigItem;t.id=i.substring(1,i.lastIndexOf("]")),this.items.push(t),e++;continue}let r="",n="",o=!0,h=i.split(" ");for(let t=0,i=h.length;t<i;++t)"="!=h[t]?o?r+=h[t]+" ":n+=h[t]+" ":o=!1;r=r.replace(/\s*$/,""),n=n.replace(/\s*$/,""),""!=r&&(r=r.toLowerCase(),this.items[e].args[r]=n)}},getItemCount:function(){return this.items.length},getValue:function(t,i){return this.items[t].args[i]}},Smal.TextureType={TEXTURE:0,NORMALMAP:1,OCCLUSIONMAP:2,CUBEMAP:3},Smal.TextureManager=function(t){this.gl=t,t||log("[ERROR] Smal.TextureManager.contructor requires GL context as a param."),this.textures={},this.count=0,this.defaultImage=this.createDefaultImage(),this.defaultNormalmap=this.createDefaultNormalmap(),this.defaultOcclusionmap=this.createDefaultOcclusionmap()},Smal.TextureManager.prototype={load:function(t,i,e,s){let r=null,n=t.substring(t.lastIndexOf("/")+1);if(!n)return r=e==Smal.TextureType.NORMALMAP?this.textures.defaultNormalmap:e==Smal.TextureType.OCCLUSIONMAP?this.textures.defaultOcclusionmap:this.textures.defaultImage,s&&s(r),r;if(n in this.textures)return r=this.textures[n],s&&s(r),r;let o=this.defaultImage;e==Smal.TextureType.NORMALMAP?o=this.defaultNormalmap:e==Smal.TextureType.OCCLUSIONMAP&&(o=this.defaultOcclusionmap),r=this.gl.createTexture(),this.setupTexture(r,o,i,e),this.textures[n]=r,this.count++,(o=new Image).crossOrigin="anonymous";let h=this;return o.onload=function(){h.setupTexture(r,o,i,e),s&&s(r)},o.onerror=function(){r=e==Smal.TextureType.NORMALMAP?h.textures.defaultNormalmap:e==Smal.TextureType.NORMALMAP?h.textures.defaultOcclusionmap:h.textures.defaultImage,s&&s(r)},o.src=t,r},setupTexture:function(t,i,e,s){let r=this.gl,n=r.RGBA;s==Smal.TextureType.OCCLUSIONMAP&&(n=r.LUMINANCE),r.bindTexture(r.TEXTURE_2D,t),r.texImage2D(r.TEXTURE_2D,0,n,n,r.UNSIGNED_BYTE,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR),e?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.REPEAT),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.REPEAT)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE)),r.generateMipmap(r.TEXTURE_2D),r.bindTexture(r.TEXTURE_2D,null)},createDefaultImage:function(){this.textures.defaultImage=this.gl.createTexture(),this.count++;let t=this,i=new Image;return i.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QsSDzYcefWBUwAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAGklEQVQoz2P8//8/AymAiYFEMKphVMPQ0QAAVW0DHZ8uFaIAAAAASUVORK5CYII=",i.onload=function(){t.setupTexture(t.textures.defaultImage,i,!0)},i},createDefaultNormalmap:function(){this.textures.defaultNormalmap=this.gl.createTexture(),this.count++;let t=this,i=new Image;return i.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AYYDSMuqtrSDwAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAGklEQVQoz2Osr//PQApgYiARjGoY1TB0NAAARsACHZTLr4oAAAAASUVORK5CYII=",i.onload=function(){t.setupTexture(t.textures.defaultNormalmap,i,!0)},i},createDefaultOcclusionmap:function(){this.textures.defaultOcclusionmap=this.gl.createTexture(),this.count++;let t=this,i=new Image;return i.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAAAAADhZOFXAAAACXBIWXMAAAsSAAALEgHS3X78AAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAABBJREFUCNdj/M8AAUwMFDEASUEBD7IJnWIAAAAASUVORK5CYII=",i.onload=function(){t.setupTexture(t.textures.defaultOcclusionmap,i,!0,Smal.TextureType.OCCLUSIONMAP)},i},get:function(t){return this.textures[t]},getIndexOf:function(t){let i,e=0;for(i in this.textures){if(e==t)break;++e}return e<this.count?this.textures[i]:this.textures.defaultImage},getTextureNames:function(){let t=[];for(key in this.textures)t.push(key);return t},toString:function(){let t="===== Texture Manager =====\n";t+="Texture Count: "+this.count+"\n";let i=0;for(let e in this.textures)t+=i+++": "+e+"\n";return t}},Smal.ShaderManager=function(t){this.gl=t,t||log("[ERROR] Smal.ShaderManager.contructor requires GL context as a param."),this.programs={},this.count=0},Smal.ShaderManager.prototype={load:function(t,i,e){e||(e=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."))),this.programs[e]=null,this.count++;let s=[t,i],r=this;return Promise.all(s.map(this.loadShaderSource)).then(t=>{let i=r.createProgram(t[0],t[1]);return i?(void 0===r.programs[e]&&r.count++,r.programs[e]=i):r.removeProgram(e),i}).catch(t=>(r.removeProgram(e),null))},loadShaderSource:function(t){return new Promise((i,e)=>{let s=new XMLHttpRequest;s.open("GET",t),s.send(),s.onload=(()=>{if(200==s.status)i(s.response);else{let i="[ERROR] Failed to load glsl file("+s.status+"): "+t.substring(t.lastIndexOf("/")+1);e(i)}}),s.onerror=(()=>e("[ERROR] Failed to load glsl file: "+t))})},createProgram:function(t,i){let e=this.gl,s=e.createShader(e.VERTEX_SHADER),r=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(s,t),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))return log("[ERROR] "+e.getShaderInfoLog(s)),null;if(e.shaderSource(r,i),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))return log("[ERROR] "+e.getShaderInfoLog(r)),null;let n,o=e.createProgram();if(e.attachShader(o,s),e.attachShader(o,r),e.deleteShader(s),e.deleteShader(r),o.uniform=[],o.attribute=[],e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS))return log("[ERROR] Failed to initialize GLSL: "+e.getProgramInfoLog(o)),null;let h=e.getProgramParameter(o,e.ACTIVE_UNIFORMS);for(n=0;n<h;++n){let t,i,s=e.getActiveUniform(o,n),r=s.name.indexOf(".");r>=0?(t=s.name.substring(0,r),i=s.name.substring(r+1),void 0===o.uniform[t]&&(o.uniform[t]={}),o.uniform[t][i]=e.getUniformLocation(o,s.name)):o.uniform[s.name]=e.getUniformLocation(o,s.name)}for(h=e.getProgramParameter(o,e.ACTIVE_ATTRIBUTES),n=0;n<h;++n){let t=e.getActiveAttrib(o,n);o.attribute[t.name]=e.getAttribLocation(o,t.name)}return o},removeProgram:function(t){void 0!==this.programs[t]&&(delete this.programs[t],this.count--)},getProgram:function(t){return this.programs[t]},getProgramNames:function(){let t=[];for(key in this.programs)t.push(key);return t},getProgramUniforms:function(t){let i=[];for(key in this.programs[t].uniform)i.push(key);return i},getProgramAttributes:function(t){let i=[];for(key in this.programs[t].attribute)i.push(key);return i},toString:function(){let t="===== ShaderManager =====\n";t+="Shader Count: "+this.count+"\n";let i=1;for(key in this.programs)t+=i+++": "+key+"\n";return t}},Smal.VertexBufferData=function(t){this.gl=t,t||log("[ERROR] Smal.VertexBufferData.contructor requires GL context as a param."),this.vboVertex=null,this.vboIndex=null,this.texId=null,this.indexCount=0,this.polygonCount=0,this.vertexSize=0,this.normalSize=0,this.texCoordSize=0,this.tangentSize=0,this.indexSize=0,this.interleavedSize=0,this.stride=0,this.center=new Smal.Vector3(0,0,0),this.radius=0,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.minZ=0,this.maxZ=0,this.drawMode=1,this.ready=!1,this.textureUsed=!1,this.normalMapUsed=!1,this.occlusionMapUsed=!1,this.indexType=t.UNSIGNED_SHORT},Smal.VertexBufferData.prototype={read:function(t){let i,e,s,r,n;return new Promise((o,h)=>{let a=this,l=new XMLHttpRequest;l.open("GET",t),l.responseType="arraybuffer",l.send(),l.onload=(()=>{200==l.status?(!function(t,o){vertices=i=e=s=r=n=null,t.ready=t.textureUsed=t.normalMapUsed=t.occlusionMapUsed=!1,t.indexSize=t.indexCount=t.polygonCount=t.vertexSize=t.normalSize=t.texCoordSize=t.tangentSize=0,t.interleavedSize=t.stride=0;let h=0,a=new Uint8Array(o,h,4),l=t.checkMagic(a),u=4;l>=0&&(h+=4,l%5==2&&(u=5));let m=new Uint32Array(o,h,u);h+=4*u;let c=new Float32Array(o,h,6);h+=24,t.indexCount=m[0],t.polygonCount=m[0]/3,t.vertexSize=12*m[1],t.normalSize=12*m[2],t.texCoordSize=8*m[3],5==u&&(t.tangentSize=12*m[4]);m[1]<=65535?t.indexType=t.gl.UNSIGNED_SHORT:t.indexType=t.gl.UNSIGNED_INT;t.interleavedSize=t.vertexSize+t.normalSize+t.texCoordSize+t.tangentSize,t.stride=12,t.normalSize>0&&(t.stride+=12);t.texCoordSize>0&&(t.stride+=8);t.tangentSize>0&&(t.stride+=12);if(l<0){t.indexSize=4*m[0];let i=new Uint32Array(o,h,m[0]);n=new Uint16Array(t.indexCount);for(let t=0;t<m[0];++t)n[t]=i[t]}else m[1]<=65535?(t.indexSize=2*m[0],n=new Uint16Array(o,h,m[0]),m[0]%2!=0&&(h+=2)):(t.indexSize=4*m[0],n=new Uint32Array(o,h,m[0]));if(l<=4){h+=t.indexSize,vertices=new Float32Array(o,h,3*m[1]),h+=t.vertexSize,i=new Float32Array(o,h,3*m[2]),h+=t.normalSize,e=new Float32Array(o,h,2*m[3]),5==u&&(h+=t.texCoordSize,s=new Float32Array(o,h,3*m[4])),r=new Float32Array(t.interleavedSize/4);let n,a,l,c=3*m[1];if(t.tangentSize>0)for(n=0,a=0,l=0;n<c;n+=3,a+=2)r[l++]=vertices[n],r[l++]=vertices[n+1],r[l++]=vertices[n+2],r[l++]=i[n],r[l++]=i[n+1],r[l++]=i[n+2],r[l++]=e[a],r[l++]=e[a+1],r[l++]=s[n],r[l++]=s[n+1],r[l++]=s[n+2];else if(t.texCoordSize>0)for(n=0,a=0,l=0;n<c;n+=3,a+=2)r[l++]=vertices[n],r[l++]=vertices[n+1],r[l++]=vertices[n+2],r[l++]=i[n],r[l++]=i[n+1],r[l++]=i[n+2],r[l++]=e[a],r[l++]=e[a+1];else if(t.normalSize>0)for(n=0,l=0;n<c;n+=3)r[l++]=vertices[n],r[l++]=vertices[n+1],r[l++]=vertices[n+2],r[l++]=i[n],r[l++]=i[n+1],r[l++]=i[n+2]}else h+=t.indexSize,r=new Float32Array(o,h,m[1]*t.stride/4);t.minX=c[0],t.maxX=c[1],t.minY=c[2],t.maxY=c[3],t.minZ=c[4],t.maxZ=c[5],t.center.x=(c[0]+c[1])/2,t.center.y=(c[2]+c[3])/2,t.center.z=(c[4]+c[5])/2;let d=(c[1]-c[0])/2,f=(c[3]-c[2])/2,x=(c[5]-c[4])/2;t.radius=Math.sqrt(d*d+f*f+x*x),t.texCoordSize>0&&(t.textureUsed=!0);(function(t){let i=t.gl;t.vboVertex||(t.vboVertex=i.createBuffer());i.bindBuffer(i.ARRAY_BUFFER,t.vboVertex),i.bufferData(i.ARRAY_BUFFER,r,i.STATIC_DRAW),t.vboIndex||(t.vboIndex=i.createBuffer());i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.vboIndex),i.bufferData(i.ELEMENT_ARRAY_BUFFER,n,i.STATIC_DRAW)})(t),vertices=i=e=s=r=n=null,t.ready=!0}(a,l.response),o(a)):h("[ERROR] Failed to load a file: (file) ((xhr.status))")}),l.onerror=(()=>h("[ERROR] Failed to load a file: "+t+" ("+l.status+")"))})},draw:function(){let t=this.gl;if(!this.vboVertex||!this.vboIndex)return!1;t.bindBuffer(t.ARRAY_BUFFER,this.vboVertex),t.vertexAttribPointer(t.program.attribute.vertexPosition,3,t.FLOAT,!1,this.stride,0),t.vertexAttribPointer(t.program.attribute.vertexNormal,3,t.FLOAT,!1,this.stride,12),this.normalMapUsed&&this.texCoordSize>0&&this.tangentSize>0&&(t.vertexAttribPointer(t.program.attribute.vertexTexCoord0,2,t.FLOAT,!1,this.stride,24),t.vertexAttribPointer(t.program.attribute.vertexTangent,3,t.FLOAT,!1,this.stride,32)),(this.textureUsed||this.occlusionMapUsed)&&this.texCoordSize>0&&t.vertexAttribPointer(t.program.attribute.vertexTexCoord0,2,t.FLOAT,!1,this.stride,24),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.vboIndex),2==this.drawMode?t.drawElements(t.LINE_STRIP,this.indexCount,this.indexType,0):3==this.drawMode?t.drawElements(t.POINTS,this.indexCount,this.indexType,0):t.drawElements(t.TRIANGLES,this.indexCount,this.indexType,0)},checkMagic:function(t){return 86==t[0]&&66==t[1]&&68==t[2]?t[3]-48:-1},toString:function(){return"===== VBD Model =====\n Polygon Count: "+this.polygonCount+" tris\n   Index Count: "+this.indexCount+"\n  Vertex Count: "+this.vertexSize/12+"\n  Normal Count: "+this.normalSize/12+"\nTexCoord Count: "+this.texCoordSize/8+"\n Tangent Count: "+this.tangentSize/12+"\n  Model Center: "+this.center+"\n  Model Radius: "+this.radius.toFixed(5)+"\n"}},Smal.Sprite=function(t){this.gl=t,t?this.vboVertex=t.createBuffer():(this.vboVertex=null,log("[WARNING] Smal.Sprite.contructor requires GL context as a param.")),this.width=0,this.height=0,this.texId=null,this.texCoords=new Smal.Vector4(0,0,1,1),this.color=new Smal.Vector4(1,1,1,1),this.matrix=new Smal.Matrix4,this.matrix.identity()},Smal.Sprite.prototype={setPosition:function(t,i,e){return this.matrix.setTranslation(t||0,i||0,e||0),this},getPosition:function(){return new Smal.Vector3(this.matrix.m[12],this.matrix.m[13],this.matrix.m[14])},setSize:function(t,i){let e=this.gl;this.vboVertex||(this.vboVertex=e.createBuffer()),this.width=t||0,this.height=i||0;let s=new Float32Array(20);return s[0]=.5*-this.width,s[1]=.5*this.height,s[2]=0,s[3]=this.texCoords.x,s[4]=this.texCoords.y,s[5]=.5*-this.width,s[6]=.5*-this.height,s[7]=0,s[8]=this.texCoords.x,s[9]=this.texCoords.w,s[10]=.5*this.width,s[11]=.5*this.height,s[12]=0,s[13]=this.texCoords.z,s[14]=this.texCoords.y,s[15]=.5*this.width,s[16]=.5*-this.height,s[17]=0,s[18]=this.texCoords.z,s[19]=this.texCoords.w,e.bindBuffer(e.ARRAY_BUFFER,this.vboVertex),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),this},setColor:function(t,i,e,s){return this.color.set(t,i,e,s),this},setTexture:function(t){return this.texId=t,this},setTexCoords:function(t,i,e,s){return this.texCoords.set(t,i,e,s),this},bindTexture:function(){return this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texId),this},unbindTexture:function(){return this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.disableVertexAttribArray(this.gl.program.attribute.vertexTexCoord0),this},draw:function(){if(!this.vboVertex)return!1;let t=this.gl;return t.uniformMatrix4fv(t.program.uniform.matrixModel,!1,this.matrix.m),t.bindBuffer(t.ARRAY_BUFFER,this.vboVertex),t.vertexAttribPointer(t.program.attribute.vertexPosition,3,t.FLOAT,!1,20,0),t.vertexAttribPointer(t.program.attribute.vertexTexCoord0,2,t.FLOAT,!1,20,12),t.drawArrays(t.TRIANGLE_STRIP,0,4),this},toString:function(){return"===== Sprite =====\n Position: ("+this.matrix.m[12]+", "+this.matrix.m[13]+", "+this.matrix.m[14]+")\n    Width: "+this.width+"\n   Height: "+this.height+"\nTexCoords: "+this.texCoords+"\n"}};let BitmapQuad=new Float32Array(20);Smal.BitmapCharacter=function(){this.x=0,this.y=0,this.width=0,this.height=0,this.xOffset=0,this.yOffset=0,this.xAdvance=0,this.page=0,this.s1=0,this.s2=1,this.t1=0,this.t2=1},Smal.BitmapFont=function(t){this.gl=t,t||log("[ERROR] Smal.BitmapFont.contructor requires GL context as a param."),this.height=0,this.base=0,this.bitmap=null,this.bitmapWidth=0,this.bitmapHeight=0,this.bitmapWidthInv=1,this.bitmapHeightInv=1,this.characterCount=0,this.pages=[],this.characters={},this.kernings={},this.path="",this.vbo=null,this.vbo2=null,this.scale=[1,1],this.matrix=new Smal.Matrix4,this.matrix.identity()},Smal.BitmapFont.prototype={loadFont:function(t){this.path=t.substring(0,t.lastIndexOf("/")+1),this.bitmap=t.substring(t.lastIndexOf("/")+1);let i=this;Smal.loadFile(t).then(t=>{i.parse(t),i.setUvs()})},parse:function(t){for(let t=0;t<this.pages.length;++t)this.gl.deleteTexture(this.pages[t]);this.pages.length=0,this.kernings={},this.characters={},this.vbo||(this.vbo=this.gl.createBuffer());let i=t.split("\n");for(let t=0,e=i.length;t<e;++t){let e=i[t].split(" "),s=e.shift();"info"==s||("common"==s?this.parseCommon(e):"page"==s?this.parsePage(e):"chars"==s?this.parseCharacterCount(e):"char"==s?this.parseCharacter(e):"kerning"==s&&this.parseKerning(e))}},getKeyAndValue:function(t){let i=t.split("=");return{key:i[0],value:i[1]}},trimQuotes:function(t){return t.substring(1,t.length-2)},parseCommon:function(t){for(let i=0,e=t.length;i<e;++i){let e=this.getKeyAndValue(t[i]);"lineHeight"==e.key?this.height=parseInt(e.value):"base"==e.key?this.base=parseInt(e.value):"scaleW"==e.key?(this.bitmapWidth=parseInt(e.value),this.bitmapWidthInv=1/this.bitmapWidth):"scaleH"==e.key&&(this.bitmapHeight=parseInt(e.value),this.bitmapHeightInv=1/this.bitmapHeight)}},parsePage:function(t){for(let i=0,e=t.length;i<e;++i){let e=this.getKeyAndValue(t[i]);if("file"==e.key){let t=this.path+this.trimQuotes(e.value),i=Smal.loadTexture(this.gl,t,!1);this.pages.push(i)}}},parseCharacter:function(t){let i=null;for(let e=0,s=t.length;e<s;++e){let s=this.getKeyAndValue(t[e]);if("id"==s.key){i=parseInt(s.value);let t=new Smal.BitmapCharacter;this.characters[i]=t}else"x"==s.key?this.characters[i].x=parseInt(s.value):"y"==s.key?this.characters[i].y=parseInt(s.value):"width"==s.key?this.characters[i].width=parseInt(s.value):"height"==s.key?this.characters[i].height=parseInt(s.value):"xoffset"==s.key?this.characters[i].xOffset=parseInt(s.value):"yoffset"==s.key?this.characters[i].yOffset=parseInt(s.value):"xadvance"==s.key?this.characters[i].xAdvance=parseInt(s.value):"page"==s.key&&(this.characters[i].page=parseInt(s.value))}},parseCharacterCount:function(t){for(let i=0,e=t.length;i<e;++i){let e=this.getKeyAndValue(t[i]);"count"==e.key&&(this.characterCount=parseInt(e.value))}},parseKerning:function(t){let i="";for(let e=0,s=t.length;e<s;++e){let s=this.getKeyAndValue(t[e]);"first"==s.key?i=s.value:"second"==s.key?i+="-"+s.value:"amount"==s.key&&(this.kernings[i]=parseInt(s.value))}},setUvs:function(){let t;for(let i in this.characters)(t=this.characters[i]).s1=t.x*this.bitmapWidthInv,t.s2=(t.x+t.width)*this.bitmapWidthInv,t.t1=t.y*this.bitmapHeightInv,t.t2=(t.y+t.height)*this.bitmapHeightInv},drawText:function(t,i,e,s){let r,n,o,h,a=this.gl;if(0==this.pages.length)return;this.matrix.setTranslation(i,e,s),a.uniformMatrix4fv(a.program.uniform.matrixModel,!1,this.matrix.m);let l=0,u=0,m="",c=0;for(let i=0,e=t.length;i<e;++i){m=l+"-"+(u=t.charCodeAt(i)),c+=this.kernings[m]||0;let e=this.characters[u];n=(r=(c+e.xOffset)*this.scale[0])+e.width*this.scale[0],h=(o=(this.base-e.yOffset)*this.scale[1])-e.height*this.scale[1],BitmapQuad[0]=r,BitmapQuad[1]=o,BitmapQuad[2]=0,BitmapQuad[3]=e.s1,BitmapQuad[4]=e.t1,BitmapQuad[5]=r,BitmapQuad[6]=h,BitmapQuad[7]=0,BitmapQuad[8]=e.s1,BitmapQuad[9]=e.t2,BitmapQuad[10]=n,BitmapQuad[11]=o,BitmapQuad[12]=0,BitmapQuad[13]=e.s2,BitmapQuad[14]=e.t1,BitmapQuad[15]=n,BitmapQuad[16]=h,BitmapQuad[17]=0,BitmapQuad[18]=e.s2,BitmapQuad[19]=e.t2,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.pages[e.page]),a.bindBuffer(a.ARRAY_BUFFER,this.vbo),a.bufferData(a.ARRAY_BUFFER,BitmapQuad,a.STATIC_DRAW),a.vertexAttribPointer(a.program.attribute.vertexPosition,3,a.FLOAT,!1,20,0),a.vertexAttribPointer(a.program.attribute.vertexTexCoord0,2,a.FLOAT,!1,20,12),a.drawArrays(a.TRIANGLE_STRIP,0,4),c+=this.characters[u].xAdvance,l=u}return this},getTextWidth:function(t){let i=0,e=0,s="",r=0;for(let n=0,o=t.length;n<o;++n)s=i+"-"+(e=t.charCodeAt(n)),r+=this.kernings[s]||0,r+=this.characters[e].xAdvance,i=e;return Math.round(r*this.scale[0])},setScale:function(t,i){return this.scale[0]=t,this.scale[1]=i,this},toString:function(){return"===== BitmapFont =====\n         Bitmap: "+this.bitmap+"\n    Bitmap Size: "+this.bitmapWidth+" x "+this.bitmapHeight+"\n    Line Height: "+this.height+"\n           Base: "+this.base+"\nCharacter Count: "+this.characterCount+"\n"}};let LineVertices=new Float32Array(18);Smal.LineSegment=function(t){this.gl=t,t||log("[WARNING] Line.contructor requires GL context as a param."),this.vbo=t.createBuffer(),this.width=1,this.widthRatio=1},Smal.LineSegment.prototype={setWidth:function(t,i){return this.width=t,this.widthRatio=i||1,this},draw:function(t,i,e,s,r,n){let o=this.gl;if(this.width<=1)LineVertices[0]=t,LineVertices[1]=i,LineVertices[2]=e,LineVertices[3]=s,LineVertices[4]=r,LineVertices[5]=n,o.bindBuffer(o.ARRAY_BUFFER,this.vbo),o.bufferData(o.ARRAY_BUFFER,LineVertices,o.DYNAMIC_DRAW),o.vertexAttribPointer(o.program.attribute.vertexPosition,3,o.FLOAT,!1,0,0),o.drawArrays(o.LINES,0,2);else{let h=new Smal.Vector3(s-t,r-i,n-e);h.normalize();let a=new Smal.Vector3(0,0,1);Math.abs(h.x)<Math.abs(h.y)?Math.abs(h.x)<Math.abs(h.z)&&a.set(1,0,0):Math.abs(h.y)<Math.abs(h.z)&&a.set(0,1,0);let l=Smal.Vector3.cross(a,h),u=this.width*this.widthRatio*.5,m=l.clone().scale(u),c=h.clone().scale(u);LineVertices[0]=t+m.x,LineVertices[1]=i+m.y,LineVertices[2]=e+m.z,LineVertices[3]=t-c.x,LineVertices[4]=i-c.y,LineVertices[5]=e-c.z,LineVertices[6]=t-m.x,LineVertices[7]=i-m.y,LineVertices[8]=e-m.z,LineVertices[9]=s-m.x,LineVertices[10]=r-m.y,LineVertices[11]=n-m.z,LineVertices[12]=s+c.x,LineVertices[13]=r+c.y,LineVertices[14]=n+c.z,LineVertices[15]=s+m.x,LineVertices[16]=r+m.y,LineVertices[17]=n+m.z,o.bindBuffer(o.ARRAY_BUFFER,this.vbo),o.bufferData(o.ARRAY_BUFFER,LineVertices,o.DYNAMIC_DRAW),o.vertexAttribPointer(o.program.attribute.vertexPosition,3,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLE_FAN,0,6)}return this}},Smal.ObjGroup=function(){this.name="",this.materialName="",this.indexOffset=0,this.indexCount=0},Smal.ObjModel=function(){this.groupCount=0,this.vertexCount=0,this.normalCount=0,this.texCoordCount=0,this.indexCount=0,this.triangleCount=0,this.groups=[],this.vertices=null,this.normals=null,this.texCoords=null,this.indices=null,this.center=new Smal.Vector3,this.radius=0,this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0},Smal.ObjModel.prototype={read:function(t){return new Promise((e,s)=>{t||s("[ERROR] NULL OBJ filename");let r=this;if(t instanceof String||"string"==typeof t){let n=new XMLHttpRequest;n.open("GET",t,!0),n.send(),n.onload=function(o){200==n.status?(i(r,n.responseText),e(r)):s("[ERROR] Failed to load OBJ file: "+t+" (status:"+n.status+")")},n.onerror=function(i){s("[ERROR] Failed to load OBJ file: "+t)}}else if(t instanceof window.File){let n=new FileReader;n.readAsText(t),n.onload=function(t){i(r,t.target.result),e(r)},n.onerror=function(i){s("[ERROR] Failed to load OBJ file"+t.name)}}});function i(t,i){t.vertices=t.normals=t.texCoords=t.indices=null,t.groups.length=0;let s,r,n,o,h,a=[],l=[],u=[],m=[],c=[],d=[],f=[],x={},g=-1,C=i.split(/\r\n|\r|\n/);for(n in C)if("#"!=(s=C[n]).charAt(0)&&!((r=s.split(" ")).length<=0))if("g"==r[0]){let i=r[1],e=-1;for(o in t.groups)t.groups[o].name==i&&(e=o);if(e>=0)g=e;else{let e=new Smal.ObjGroup;e.name=i,t.groups.push(e),g=t.groups.length-1}}else if("mtllib"==r[0]);else if("usemtl"==r[0]);else if("v"==r[0])c.push(parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3]));else if("vn"==r[0])d.push(parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3]));else if("vt"==r[0])f.push(parseFloat(r[1]),1-parseFloat(r[2]));else if("f"==r[0]){let t,i,s,n;for(t=r.length>4?e(r):[r[1],r[2],r[3]],h=0;h<t.length;h++)if(void 0==x[t[h]]){let e=t[h].split("/");i=3*(parseInt(e[0])-1),a.push(c[i],c[i+1],c[i+2]),1==e.length||(2==e.length?t[h].search("//")>0?(s=3*(parseInt(e[1])-1),l.push(d[s],d[s+1],d[s+2])):(n=2*(parseInt(e[1])-1),u.push(f[n],f[n+1])):3==e.length&&(s=3*(parseInt(e[2])-1),n=2*(parseInt(e[1])-1),l.push(d[s],d[s+1],d[s+2]),u.push(f[n],f[n+1])));let r=a.length/3-1;x[t[h]]=r,m.push(r)}else m.push(x[t[h]])}t.vertices=new Float32Array(a),t.normals=new Float32Array(l),t.texCoords=new Float32Array(u),t.indices=new Uint16Array(m),t.vertexCount=t.vertices.length/3||0,t.normalCount=t.normals.length/3||0,t.texCoordCount=t.texCoords.length/2||0,t.indexCount=t.indices.length||0,t.triangleCount=t.indexCount/3||0,function(t){t.minX=1/0,t.minY=1/0,t.minZ=1/0,t.maxX=-1/0,t.maxY=-1/0,t.maxZ=-1/0;let i=new Smal.Vector3,e=t.vertices.length;for(let s=0;s<e;s+=3)i.set(t.vertices[s],t.vertices[s+1],t.vertices[s+2]),t.minX=Math.min(i.x,t.minX),t.maxX=Math.max(i.x,t.maxX),t.minY=Math.min(i.y,t.minY),t.maxY=Math.max(i.y,t.maxY),t.minZ=Math.min(i.z,t.minZ),t.maxZ=Math.max(i.z,t.maxZ);t.center.x=(t.maxX+t.minX)/2,t.center.y=(t.maxY+t.minY)/2,t.center.z=(t.maxZ+t.minZ)/2,t.radius=0;for(let s=0;s<e;s+=3)i.set(t.vertices[s],t.vertices[s+1],t.vertices[s+2]),t.radius=Math.max(t.radius,t.center.distance(i))}(t)}function e(t){let i=[];i.push(t[1]),i.push(t[2]),i.push(t[3]);let e=t.length;for(let s=4;s<e;++s)i.push(t[s-1]),i.push(t[s]),i.push(t[1]);return i}},normalize:function(){let t=this.normals.length;for(let i=0;i<t;i+=3){let t=1/Math.sqrt(this.normals[i]*this.normals[i]+this.normals[i+1]*this.normals[i+1]+this.normals[i+2]*this.normals[i+2]);this.normals[i]*=t,this.normals[i+1]*=t,this.normals[i+2]*=t}},clearArrays:function(){this.vertices=null,this.normals=null,this.texCoords=null,this.indices=null,this.groups.length=0,this.vertexCount=0,this.normalCount=0,this.texCoordCount=0,this.indexCount=0,this.groupCount=0},toString:function(){return"===== OBJ Model =====\nTriangle Count: "+this.triangleCount+"\n   Index Count: "+this.indexCount+"\n   Group Count: "+this.groups.length+"\n  Vertex Count: "+this.vertexCount+"\n  Normal Count: "+this.normalCount+"\nTexCoord Count: "+this.texCoordCount+"\n        Center: "+this.center+"\n        Radius: "+Math.round(1e5*this.radius)/1e5+"\n"}},Smal.ObjModel.toVertices=function(t){let i=[];if(!(t&&t instanceof Smal.ObjModel))return i;for(let e=0;e<t.indexCount;++e){let s=3*t.indices[e],r=new Smal.Vector3(t.vertices[s],t.vertices[s+1],t.vertices[s+2]);i.push(r)}return i},Smal.Edge=function(){this.vertex1=new Smal.Vector3,this.vertex2=new Smal.Vector3,this.normal1=new Smal.Vector3,this.normal2=new Smal.Vector3},Smal.Edge.prototype={toString:function(){return"===== Edge =====\nVertex1: "+this.vertex1+"\nVertex2: "+this.vertex2+"\nNormal1: "+this.normal1+"\nNormal2: "+this.normal2+"\n"}},Smal.Edge.generateEdges=function(t){let i=[];for(let e=0,s=t.length;e<s;e+=3){let s=t[e].clone(),r=t[e+1].clone(),n=t[e+2].clone();r.subtract(s),n.subtract(s);let o=Smal.Vector3.cross(r,n).normalize();r=t[e+1].clone(),n=t[e+2].clone();let h=[];h[0]=new Smal.Edge,h[0].vertex1.set(s.x,s.y,s.z),h[0].vertex2.set(r.x,r.y,r.z),h[0].normal1.set(o.x,o.y,o.z),h[1]=new Smal.Edge,h[1].vertex1.set(r.x,r.y,r.z),h[1].vertex2.set(n.x,n.y,n.z),h[1].normal1.set(o.x,o.y,o.z),h[2]=new Smal.Edge,h[2].vertex1.set(n.x,n.y,n.z),h[2].vertex2.set(s.x,s.y,s.z),h[2].normal1.set(o.x,o.y,o.z);for(let t=0;t<3;++t){let e=Smal.Edge.findIndex(i,h[t]);e<0?i.push(h[t]):i[e].normal2.set(o.x,o.y,o.z)}}return i},Smal.Edge.generateHardEdges=function(t,i){let e=[],s=i*Math.PI/180;for(let i=0,r=t.length;i<r;++i){let r=t[i].normal1.dot(t[i].normal2);r<-1?r=-1:r>1&&(r=1),Math.acos(r)>=s&&e.push(t[i])}return e},Smal.Edge.generateOutlineEdges=function(t,i){let e=[],s=new Smal.Vector3(0,0,1);for(let r=0,n=t.length;r<n;++r){let n=t[r],o=new Smal.Vector3(n.normal1.x,n.normal1.y,n.normal1.z),h=new Smal.Vector3(n.normal2.x,n.normal2.y,n.normal2.z);o=i.transform(o),h=i.transform(h),s.dot(o)*s.dot(h)<0&&e.push(n)}return e},Smal.Edge.findIndex=function(t,i){for(let e=0,s=t.length;e<s;++e){let s=t[e];if(i.vertex1.x==s.vertex2.x&&i.vertex1.y==s.vertex2.y&&i.vertex1.z==s.vertex2.z&&i.vertex2.x==s.vertex1.x&&i.vertex2.y==s.vertex1.y&&i.vertex2.z==s.vertex1.z)return e}return-1},Smal.Edge.toFloat32Array=function(t){let i=t.length,e=0,s=new Float32Array(2*i*3);for(let r=0;r<i;++r)s[e=6*r]=t[r].vertex1.x,s[e+1]=t[r].vertex1.y,s[e+2]=t[r].vertex1.z,s[e+3]=t[r].vertex2.x,s[e+4]=t[r].vertex2.y,s[e+5]=t[r].vertex2.z;return s};const PEN_WIDTH=10,PEN_COLOR=new Float32Array([0,0,0,1]),PEN_TOOL_BLOCK_SIZE=128;Smal.PenTool=function(t){this.gl=t,t||log("[ERROR] Smal.PenTool.contructor requires GL context as a param."),this.vbo=t.createBuffer(),this.points=null,this.pointCount=0,this.pointCapacity=128,this.stroke={},this.stroke.color=PEN_COLOR,this.stroke.width=10,this.stroke.start=0,this.stroke.end=0,this.strokes=[],this.prevX=null,this.prevY=null,this.reset()},Smal.PenTool.prototype={setWidth:function(t){this.stroke.width=t},setColor:function(t,i,e,s){this.stroke.color[0]=t,this.stroke.color[1]=i,this.stroke.color[2]=e,this.stroke.color[3]=s},reset:function(){this.points=new Float32Array(256),this.pointCount=0,this.pointCapacity=128,this.strokes.length=0,this.resizeVbo()},undo:function(){if(this.strokes.length<1)return;this.strokes.pop();let t=this.strokes[this.strokes.length-1];t?(this.pointCount=t.end+1,this.stroke.start=t.start):(this.pointCount=0,this.stroke.start=0)},increaseBuffer:function(t){for(;this.pointCapacity<t;)this.pointCapacity+=128;let i=new Float32Array(2*this.pointCapacity);for(let t=0;t<this.points.length;++t)i[t]=this.points[t];this.points=i,this.resizeVbo()},resizeVbo:function(){if(!this.gl)return null;let t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,this.vbo),t.bufferData(t.ARRAY_BUFFER,this.points,t.DYNAMIC_DRAW)},updateVbo:function(){if(!this.gl)return null;let t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,this.vbo),t.bufferSubData(t.ARRAY_BUFFER,0,this.points)},startAt:function(t,i){this.pointCount+1>=this.pointCapacity&&this.increaseBuffer(this.pointCount+1);let e=2*this.pointCount;this.points[e]=t,this.points[e+1]=i,this.stroke.start=this.pointCount,this.strokes.length>0&&(this.strokes[this.strokes.length-1].end=this.pointCount-1),this.prevX=t,this.prevY=i,++this.pointCount,this.strokes.push(this.stroke);let s={};s.color=new Float32Array(this.stroke.color),s.width=this.stroke.width,this.stroke=s,this.updateVbo()},moveTo:function(t,i){let e=t-this.prevX,s=i-this.prevY,r=Math.sqrt(e*e+s*s);if(r<1)return;let n=Math.max(Math.ceil(r/this.stroke.width*3),1);this.pointCount+n>=this.pointCapacity&&this.increaseBuffer(this.pointCount+n);let o=2*this.pointCount,h=0;for(let t=1;t<=n;++t)h=t/n,this.points[o]=this.prevX+e*h,this.points[o+1]=this.prevY+s*h,this.pointCount++,o+=2;this.prevX=t,this.prevY=i,this.updateVbo()},draw:function(){let t,i=this.gl;i.bindBuffer(i.ARRAY_BUFFER,this.vbo),i.vertexAttribPointer(i.program.attribute.vertexPosition,2,i.FLOAT,!1,0,0);for(let e=0;e<this.strokes.length-1;++e)t=this.strokes[e],i.uniform1f(i.program.uniform.pointSize,t.width),i.uniform4fv(i.program.uniform.color,t.color),i.drawArrays(i.POINTS,t.start,t.end-t.start+1);(t=this.strokes[this.strokes.length-1])&&(i.uniform1f(i.program.uniform.pointSize,t.width),i.uniform4fv(i.program.uniform.color,t.color),i.drawArrays(i.POINTS,t.start,this.pointCount-t.start))}},Smal.Quad=function(t,i,e,s,r){this.gl=t,t||log("[ERROR] Smal.Quad.contructor requires GL context as a param."),this.left=i||-.5,this.right=e||.5,this.bottom=s||-.5,this.top=r||.5,this.reversed=!1,this.vbo=t.createBuffer(),this.initVbo()},Smal.Quad.prototype={initVbo:function(){let t=new Float32Array(16);t[0]=this.left,t[1]=this.bottom,t[2]=0,t[3]=1,t[4]=this.right,t[5]=this.bottom,t[6]=1,t[7]=1,t[8]=this.right,t[9]=this.top,t[10]=1,t[11]=0,t[12]=this.left,t[13]=this.top,t[14]=0,t[15]=0,this.reversed&&(t[3]=0,t[7]=0,t[11]=1,t[15]=1);let i=this.gl;i.bindBuffer(i.ARRAY_BUFFER,this.vbo),i.bufferData(i.ARRAY_BUFFER,t,i.STATIC_DRAW)},set:function(t,i,e,s){return this.left=t,this.right=i,this.bottom=e,this.top=s,this.initVbo(),this},reverseTextureOrientation:function(){this.reversed=!this.reversed,this.initVbo()},draw:function(){let t=this.gl;return t.bindBuffer(t.ARRAY_BUFFER,this.vbo),t.vertexAttribPointer(t.program.attribute.vertexPosition,2,t.FLOAT,!1,16,0),t.vertexAttribPointer(t.program.attribute.vertexTexCoord0,2,t.FLOAT,!1,16,8),t.drawArrays(t.TRIANGLE_FAN,0,4),this}},Smal.Cylinder=function(t,i=1,e=1,s=1,r=36,n=1,o=!0){this.gl=t,t||log("[WARNING] Smal.Cylinder.contructor requires GL context as a param."),this.baseRadius=i,this.topRadius=e,this.height=s,this.sectorCount=r,this.stackCount=n,this.smooth=o,this.unitCircleVertices=[],this.vertices=[],this.normals=[],this.texCoords=[],this.indices=[],this.interleavedVertices=[],this.stride=32,t&&(this.vboVertex=t.createBuffer(),this.vboIndex=t.createBuffer()),this.buildUnitCircleVertices(),this.smooth?this.buildVerticesSmooth():this.buildVerticesFlat()},Smal.Cylinder.prototype={set:function(t,i,e,s,r,n){return this.baseRadius=t,this.topRadius=i,this.height=e,this.sectorCount=s,this.stackCount=r,this.smooth=n,this.buildUnitCircleVertices(),this.smooth?this.buildVerticesSmooth():this.buildVerticesFlat(),this},setBaseRadius:function(t){return this.baseRadius!=t&&this.set(t,this.topRadius,this.height,this.sectorCount,this.stackCount,this.smooth),this},setTopRadius:function(t){return this.topRadius!=t&&this.set(this.baseRadius,t,this.height,this.sectorCount,this.stackCount,this.smooth),this},setHeight:function(t){return this.height!=t&&this.set(this.baseRadius,this.topRadius,t,this.sectorCount,this.stackCount,this.smooth),this},setSectorCount:function(t){return this.sectorCount!=t&&this.set(this.baseRadius,this.topRadius,this.height,t,this.stackCount,this.smooth),this},setStackCount:function(t){return this.stackCount!=t&&this.set(this.baseRadius,this.topRadius,this.height,this.sectorCount,t,this.smooth),this},setSmooth:function(t){return this.smooth!=t&&(this.smooth=t,this.smooth?this.buildVerticesSmooth():this.buildVerticesFlat()),this},reverseNormals:function(){let t,i,e,s=this.normals.length;for(t=0,i=3;t<s;t+=3,i+=8)this.normals[t]*=-1,this.normals[t+1]*=-1,this.normals[t+2]*=-1,this.interleavedVertices[i]=this.normals[t],this.interleavedVertices[i+1]=this.normals[t+1],this.interleavedVertices[i+2]=this.normals[t+2];for(s=this.indices.length,t=0;t<s;t+=3)e=this.indices[t],this.indices[t]=this.indices[t+2],this.indices[t+2]=e;this.buildVbos()},getTriangleCount:function(){return this.getIndexCount()/3},getIndexCount:function(){return this.indices.length},getVertexCount:function(){return this.vertices.length/3},getNormalCount:function(){return this.normals.length/3},getTexCoordCount:function(){return this.texCoords.length/2},toString:function(){return"===== Cylinder =====\n   Base Radius: "+this.baseRadius+"\n    Top Radius: "+this.topRadius+"\n        Height: "+this.height+"\n  Sector Count: "+this.sectorCount+"\n   Stack Count: "+this.stackCount+"\n Smooth Shader: "+this.smooth+"\nTriangle Count: "+this.getTriangleCount()+"\n   Index Count: "+this.getIndexCount()+"\n  Vertex Count: "+this.getVertexCount()+"\n  Normal Count: "+this.getNormalCount()+"\nTexCoord Count: "+this.getTexCoordCount()+"\n"},clearArrays:function(){this.vertices.length=0,this.normals.length=0,this.texCoords.length=0,this.indices.length=0,this.interleavedVertices.length=0},resizeArraysSmooth:function(){this.clearArrays();let t=(this.sectorCount+1)*(this.stackCount+1),i=2*(this.sectorCount+1);this.vertices=new Float32Array(3*(t+i)),this.normals=new Float32Array(3*(t+i)),this.texCoords=new Float32Array(2*(t+i)),this.indices=new Uint16Array(6*this.sectorCount*this.stackCount+6*this.sectorCount)},resizeArraysFlat:function(){this.clearArrays();let t=4*this.sectorCount*this.stackCount,i=2*(this.sectorCount+1);this.vertices=new Float32Array(3*(t+i)),this.normals=new Float32Array(3*(t+i)),this.texCoords=new Float32Array(2*(t+i)),this.indices=new Uint16Array(6*this.sectorCount*this.stackCount+6*this.sectorCount)},buildUnitCircleVertices:function(){let t=2*Math.PI/this.sectorCount,i=0;this.unitCircleVertices.length=0,this.unitCircleVertices=new Float32Array(3*(this.sectorCount+1));for(let e=0,s=0;e<=this.sectorCount;++e,s+=3)i=e*t,this.unitCircleVertices[s]=Math.cos(i),this.unitCircleVertices[s+1]=Math.sin(i),this.unitCircleVertices[s+2]=0},buildVerticesSmooth:function(){let t,i,e,s,r,n,o,h,a,l,u;this.resizeArraysSmooth();let m=0,c=0,d=0,f=this.getSideNormals();for(o=0;o<=this.stackCount;++o)for(e=-.5*this.height+o/this.stackCount*this.height,s=this.baseRadius+o/this.stackCount*(this.topRadius-this.baseRadius),n=1-o/this.stackCount,h=0,a=0;h<=this.sectorCount;++h,a+=3)t=this.unitCircleVertices[a],i=this.unitCircleVertices[a+1],this.addVertex(m,t*s,i*s,e),this.addNormal(m,f[a],f[a+1],f[a+2]),r=h/this.sectorCount,this.addTexCoord(c,r,n),m+=3,c+=2;let x=m/3;for(e=.5*-this.height,this.addVertex(m,0,0,e),this.addNormal(m,0,0,-1),this.addTexCoord(c,.5,.5),m+=3,c+=2,o=0,h=0;o<this.sectorCount;++o,h+=3)t=this.unitCircleVertices[h],i=this.unitCircleVertices[h+1],this.addVertex(m,t*this.baseRadius,i*this.baseRadius,e),this.addNormal(m,0,0,-1),this.addTexCoord(c,.5*-t+.5,.5*-i+.5),m+=3,c+=2;let g=m/3;for(e=.5*this.height,this.addVertex(m,0,0,e),this.addNormal(m,0,0,1),this.addTexCoord(c,.5,.5),m+=3,c+=2,o=0,h=0;o<this.sectorCount;++o,h+=3)t=this.unitCircleVertices[h],i=this.unitCircleVertices[h+1],this.addVertex(m,t*this.topRadius,i*this.topRadius,e),this.addNormal(m,0,0,1),this.addTexCoord(c,.5*t+.5,.5*-i+.5),m+=3,c+=2;for(o=0;o<this.stackCount;++o)for(u=(l=o*(this.sectorCount+1))+this.sectorCount+1,h=0;h<this.sectorCount;++h,++l,++u)this.addIndices(d,l,l+1,u),this.addIndices(d+3,u,l+1,u+1),d+=6;for(o=0,a=x+1;o<this.sectorCount;++o,++a)o<this.sectorCount-1?this.addIndices(d,x,a+1,a):this.addIndices(d,x,x+1,a),d+=3;for(o=0,a=g+1;o<this.sectorCount;++o,++a)o<this.sectorCount-1?this.addIndices(d,g,a,a+1):this.addIndices(d,g,a,g+1),d+=3;this.buildInterleavedVertices(),this.buildVbos()},buildVerticesFlat:function(){let t,i,e,s,r,n,o,h,a,u,c,d,f,x,g,C,A,S=[],p={};for(t=0,m=0;t<=this.stackCount;++t)for(n=-.5*this.height+t/this.stackCount*this.height,o=this.baseRadius+t/this.stackCount*(this.topRadius-this.baseRadius),h=1-t/this.stackCount,i=0,e=0,l=0;i<=this.sectorCount;++i,e+=3,l+=2)p={x:(s=this.unitCircleVertices[e])*o,y:(r=this.unitCircleVertices[e+1])*o,z:n,s:i/this.sectorCount,t:h},S.push(p);for(this.resizeArraysFlat(),g=C=A=x=0,t=0;t<this.stackCount;++t)for(vi1=t*(this.sectorCount+1),vi2=(t+1)*(this.sectorCount+1),i=0;i<this.sectorCount;++i,++vi1,++vi2){for(a=S[vi1],u=S[vi2],c=S[vi1+1],d=S[vi2+1],this.addVertex(g,a.x,a.y,a.z),this.addVertex(g+3,u.x,u.y,u.z),this.addVertex(g+6,c.x,c.y,c.z),this.addVertex(g+9,d.x,d.y,d.z),this.addTexCoord(C,a.s,a.t),this.addTexCoord(C+2,u.s,u.t),this.addTexCoord(C+4,c.s,c.t),this.addTexCoord(C+6,d.s,d.t),f=Smal.Cylinder.computeFaceNormal(a.x,a.y,a.z,c.x,c.y,c.z,u.x,u.y,u.z),e=0;e<4;++e)this.addNormal(g+3*e,f[0],f[1],f[2]);g+=12,C+=8,this.addIndices(A,x,x+2,x+1),this.addIndices(A+3,x+1,x+2,x+3),A+=6,x+=4}let R=g/3;for(n=.5*-this.height,this.addVertex(g,0,0,n),this.addNormal(g,0,0,-1),this.addTexCoord(C,.5,.5),g+=3,C+=2,t=0,i=0;t<this.sectorCount;++t,i+=3)s=this.unitCircleVertices[i],r=this.unitCircleVertices[i+1],this.addVertex(g,s*this.baseRadius,r*this.baseRadius,n),this.addNormal(g,0,0,-1),this.addTexCoord(C,.5*-s+.5,.5*-r+.5),g+=3,C+=2;for(t=0,e=R+1;t<this.sectorCount;++t,++e)t<this.sectorCount-1?this.addIndices(A,R,e+1,e):this.addIndices(A,R,R+1,e),A+=3;let T=g/3;for(n=.5*this.height,this.addVertex(g,0,0,n),this.addNormal(g,0,0,1),this.addTexCoord(C,.5,.5),g+=3,C+=2,t=0,i=0;t<this.sectorCount;++t,i+=3)s=this.unitCircleVertices[i],r=this.unitCircleVertices[i+1],this.addVertex(g,s*this.topRadius,r*this.topRadius,n),this.addNormal(g,0,0,1),this.addTexCoord(C,.5*s+.5,.5*-r+.5),g+=3,C+=2;for(t=0,e=T+1;t<this.sectorCount;++t,++e)t<this.sectorCount-1?this.addIndices(A,T,e,e+1):this.addIndices(A,T,e,T+1),A+=3;this.buildInterleavedVertices(),this.buildVbos()},buildInterleavedVertices:function(){let t,i,e,s=this.getVertexCount();for(this.interleavedVertices.length=0,this.interleavedVertices=new Float32Array(8*s),t=0,i=0,e=0;t<this.vertices.length;t+=3,i+=2,e+=8)this.interleavedVertices[e]=this.vertices[t],this.interleavedVertices[e+1]=this.vertices[t+1],this.interleavedVertices[e+2]=this.vertices[t+2],this.interleavedVertices[e+3]=this.normals[t],this.interleavedVertices[e+4]=this.normals[t+1],this.interleavedVertices[e+5]=this.normals[t+2],this.interleavedVertices[e+6]=this.texCoords[i],this.interleavedVertices[e+7]=this.texCoords[i+1]},buildVbos:function(){let t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,this.vboVertex),t.bufferData(t.ARRAY_BUFFER,this.interleavedVertices,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.vboIndex),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)},getSideNormals:function(){let t=2*Math.PI/this.sectorCount,i=0,e=Math.atan2(this.baseRadius-this.topRadius,this.height),s=Math.cos(e),r=Math.sin(e),n=new Float32Array(3*(this.sectorCount+1));for(let e=0,o=0;e<=this.sectorCount;++e,o+=3)i=e*t,n[o]=Math.cos(i)*s,n[o+1]=Math.sin(i)*s,n[o+2]=r;return n},addVertex:function(t,i,e,s){this.vertices[t]=i,this.vertices[t+1]=e,this.vertices[t+2]=s},addNormal:function(t,i,e,s){this.normals[t]=i,this.normals[t+1]=e,this.normals[t+2]=s},addTexCoord:function(t,i,e){this.texCoords[t]=i,this.texCoords[t+1]=e},addIndices:function(t,i,e,s){this.indices[t]=i,this.indices[t+1]=e,this.indices[t+2]=s}},Smal.Cylinder.computeFaceNormal=function(t,i,e,s,r,n,o,h,a){let l=new Float32Array(3),u=s-t,m=r-i,c=n-e,d=o-t,f=h-i,x=a-e,g=m*x-c*f,C=c*d-u*x,A=u*f-m*d,S=Math.sqrt(g*g+C*C+A*A);return S>1e-6&&(l[0]=g/S,l[1]=C/S,l[2]=A/S),l},Smal.Sphere=function(t,i=1,e=36,s=18,r=!0){this.gl=t,t||log("[WARNING] Smal.Sphere.contructor requires GL context as a param."),this.radius=1,this.sectorCount=36,this.stackCount=18,this.smooth=!0,this.vertices=[],this.normals=[],this.texCoords=[],this.indices=[],this.interleavedVertices=[],this.stride=32,t&&(this.vboVertex=t.createBuffer(),this.vboIndex=t.createBuffer()),this.set(i,e,s,r)},Smal.Sphere.prototype={set:function(t,i,e,s){return this.radius=t,this.sectorCount=i,i<3&&(this.sectorCount=3),this.stackCount=e,e<2&&(this.stackCount=2),this.smooth=s,s?this.buildVerticesSmooth():this.buildVerticesFlat(),this},setRadius:function(t){return this.radius!=t&&this.set(t,this.sectorCount,this.stackCount,this.smooth),this},setSectorCount:function(t){return this.sectorCount!=t&&this.set(this.radius,t,this.stackCount,this.smooth),this},setStackCount:function(t){return this.stackCount!=t&&this.set(this.radius,this.sectorCount,t,this.smooth),this},setSmooth:function(t){return this.smooth!=t&&(this.smooth=t,this.smooth?this.buildVerticesSmooth():this.buildVerticesFlat()),this},reverseNormals:function(){let t,i,e,s=this.normals.length;for(t=0,i=3;t<s;t+=3,i+=8)this.normals[t]*=-1,this.normals[t+1]*=-1,this.normals[t+2]*=-1,this.interleavedVertices[i]=this.normals[t],this.interleavedVertices[i+1]=this.normals[t+1],this.interleavedVertices[i+2]=this.normals[t+2];for(s=this.indices.length,t=0;t<s;t+=3)e=this.indices[t],this.indices[t]=this.indices[t+2],this.indices[t+2]=e;this.buildVbos()},getTriangleCount:function(){return this.getIndexCount()/3},getIndexCount:function(){return this.indices.length},getVertexCount:function(){return this.vertices.length/3},getNormalCount:function(){return this.normals.length/3},getTexCoordCount:function(){return this.texCoords.length/2},toString:function(){return"===== Sphere =====\n        Radius: "+this.radius+"\n  Sector Count: "+this.sectorCount+"\n   Stack Count: "+this.stackCount+"\n Smooth Shader: "+this.smooth+"\nTriangle Count: "+this.getTriangleCount()+"\n   Index Count: "+this.getIndexCount()+"\n  Vertex Count: "+this.getVertexCount()+"\n  Normal Count: "+this.getNormalCount()+"\nTexCoord Count: "+this.getTexCoordCount()+"\n"},clearArrays:function(){this.vertices.length=0,this.normals.length=0,this.texCoords.length=0,this.indices.length=0,this.interleavedVertices.length=0},resizeArraysSmooth:function(){this.clearArrays();let t=(this.sectorCount+1)*(this.stackCount+1);this.vertices=new Float32Array(3*t),this.normals=new Float32Array(3*t),this.texCoords=new Float32Array(2*t),this.indices=new Uint16Array(6*this.sectorCount*(this.stackCount-1))},resizeArraysFlat:function(){this.clearArrays();let t=6*this.sectorCount+4*this.sectorCount*(this.stackCount-2);this.vertices=new Float32Array(3*t),this.normals=new Float32Array(3*t),this.texCoords=new Float32Array(2*t),this.indices=new Uint16Array(6*this.sectorCount*(this.stackCount-1))},buildVerticesSmooth:function(){let t,i,e,s,r,n,o,h,a,l,u,m,c,d,f,x;this.resizeArraysSmooth();let g,C,A=1/this.radius,S=2*Math.PI/this.sectorCount,p=Math.PI/this.stackCount;for(d=f=x=0,l=0;l<=this.stackCount;++l)for(C=Math.PI/2-l*p,s=this.radius*Math.cos(C),e=this.radius*Math.sin(C),u=0;u<=this.sectorCount;++u)g=u*S,t=s*Math.cos(g),i=s*Math.sin(g),this.addVertex(d,t,i,e),r=t*A,n=i*A,o=e*A,this.addNormal(d,r,n,o),h=u/this.sectorCount,a=l/this.stackCount,this.addTexCoord(f,h,a),d+=3,f+=2;for(l=0;l<this.stackCount;++l)for(c=(m=l*(this.sectorCount+1))+this.sectorCount+1,u=0;u<this.sectorCount;++u,++m,++c)0!=l&&(this.addIndices(x,m,c,m+1),x+=3),l!=this.stackCount-1&&(this.addIndices(x,m+1,c,c+1),x+=3);this.buildInterleavedVertices(),this.buildVbos()},buildVerticesFlat:function(){let t,i,e,s,r,n,o,h,a,l,u,m,c,d,f,x,g,C=2*Math.PI/this.sectorCount,A=Math.PI/this.stackCount,S=[],p={};for(t=0;t<=this.stackCount;++t)for(g=Math.PI/2-t*A,r=this.radius*Math.cos(g),e=this.radius*Math.sin(g),i=0;i<=this.sectorCount;++i)x=i*C,p={x:r*Math.cos(x),y:r*Math.sin(x),z:e,s:i/this.sectorCount,t:t/this.stackCount},S.push(p);for(this.resizeArraysFlat(),c=d=f=m=0,t=0;t<this.stackCount;++t)for(l=t*(this.sectorCount+1),u=(t+1)*(this.sectorCount+1),i=0;i<this.sectorCount;++i,++l,++u)n=S[l],o=S[u],h=S[l+1],a=S[u+1],0==t?(this.addVertex(c,n.x,n.y,n.z),this.addVertex(c+3,o.x,o.y,o.z),this.addVertex(c+6,a.x,a.y,a.z),this.addTexCoord(d,n.s,n.t),this.addTexCoord(d+2,o.s,o.t),this.addTexCoord(d+4,a.s,a.t),s=Smal.Sphere.computeFaceNormal(n.x,n.y,n.z,o.x,o.y,o.z,a.x,a.y,a.z),this.addNormal(c,s[0],s[1],s[2]),this.addNormal(c+3,s[0],s[1],s[2]),this.addNormal(c+6,s[0],s[1],s[2]),this.addIndices(f,m,m+1,m+2),c+=9,d+=6,f+=3,m+=3):t==this.stackCount-1?(this.addVertex(c,n.x,n.y,n.z),this.addVertex(c+3,o.x,o.y,o.z),this.addVertex(c+6,h.x,h.y,h.z),this.addTexCoord(d,n.s,n.t),this.addTexCoord(d+2,o.s,o.t),this.addTexCoord(d+4,h.s,h.t),s=Smal.Sphere.computeFaceNormal(n.x,n.y,n.z,o.x,o.y,o.z,h.x,h.y,h.z),this.addNormal(c,s[0],s[1],s[2]),this.addNormal(c+3,s[0],s[1],s[2]),this.addNormal(c+6,s[0],s[1],s[2]),this.addIndices(f,m,m+1,m+2),c+=9,d+=6,f+=3,m+=3):(this.addVertex(c,n.x,n.y,n.z),this.addVertex(c+3,o.x,o.y,o.z),this.addVertex(c+6,h.x,h.y,h.z),this.addVertex(c+9,a.x,a.y,a.z),this.addTexCoord(d,n.s,n.t),this.addTexCoord(d+2,o.s,o.t),this.addTexCoord(d+4,h.s,h.t),this.addTexCoord(d+6,a.s,a.t),s=Smal.Sphere.computeFaceNormal(n.x,n.y,n.z,o.x,o.y,o.z,h.x,h.y,h.z),this.addNormal(c,s[0],s[1],s[2]),this.addNormal(c+3,s[0],s[1],s[2]),this.addNormal(c+6,s[0],s[1],s[2]),this.addIndices(f,m,m+1,m+2),this.addIndices(f+3,m+2,m+1,m+3),c+=12,d+=8,f+=6,m+=4);this.buildInterleavedVertices(),this.buildVbos()},buildInterleavedVertices:function(){let t,i,e,s=this.getVertexCount();for(this.interleavedVertices.length=0,this.interleavedVertices=new Float32Array(8*s),t=0,i=0,e=0;t<this.vertices.length;t+=3,i+=2,e+=8)this.interleavedVertices[e]=this.vertices[t],this.interleavedVertices[e+1]=this.vertices[t+1],this.interleavedVertices[e+2]=this.vertices[t+2],this.interleavedVertices[e+3]=this.normals[t],this.interleavedVertices[e+4]=this.normals[t+1],this.interleavedVertices[e+5]=this.normals[t+2],this.interleavedVertices[e+6]=this.texCoords[i],this.interleavedVertices[e+7]=this.texCoords[i+1]},buildVbos:function(){let t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,this.vboVertex),t.bufferData(t.ARRAY_BUFFER,this.interleavedVertices,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.vboIndex),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)},addVertex:function(t,i,e,s){this.vertices[t]=i,this.vertices[t+1]=e,this.vertices[t+2]=s},addNormal:function(t,i,e,s){this.normals[t]=i,this.normals[t+1]=e,this.normals[t+2]=s},addTexCoord:function(t,i,e){this.texCoords[t]=i,this.texCoords[t+1]=e},addIndices:function(t,i,e,s){this.indices[t]=i,this.indices[t+1]=e,this.indices[t+2]=s}},Smal.Sphere.computeFaceNormal=function(t,i,e,s,r,n,o,h,a){let l=new Float32Array(3),u=s-t,m=r-i,c=n-e,d=o-t,f=h-i,x=a-e,g=m*x-c*f,C=c*d-u*x,A=u*f-m*d,S=Math.sqrt(g*g+C*C+A*A);return S>1e-6&&(l[0]=g/S,l[1]=C/S,l[2]=A/S),l},Smal.Cubesphere=function(t,i=1,e=3,s=!0){this.gl=t,t||log("[WARNING] Smal.Cubesphere.contructor requires GL context as a param."),this.radius=1,this.subdivision=3,this.smooth=!0,this.vertices=[],this.normals=[],this.texCoords=[],this.indices=[],this.interleavedVertices=[],this.stride=32,this.vertexCountPerRow=0,t&&(this.vboVertex=t.createBuffer(),this.vboIndex=t.createBuffer()),this.set(i,e,s)},Smal.Cubesphere.prototype={set:function(t,i,e){return this.radius=t,this.subdivision=i,i<0?this.subdivision=0:i>5&&(this.subdivision=5),this.smooth=e,this.vertexCountPerRow=Math.pow(2,this.subdivision)+1,e?this.buildVerticesSmooth():this.buildVerticesFlat(),this},setRadius:function(t){return this.radius!=t&&this.set(t,this.subdivision,this.smooth),this},setSideLength:function(t){let i=t*Math.sqrt(3)/2;return this.setRadius(i),this},setSubdivision:function(t){return this.subdivision!=t&&this.set(this.radius,t,this.smooth),this},setSmooth:function(t){return this.smooth!=t&&(this.smooth=t,this.smooth?this.buildVerticesSmooth():this.buildVerticesFlat()),this},reverseNormals:function(){let t,i,e,s=this.normals.length;for(t=0,i=3;t<s;t+=3,i+=8)this.normals[t]*=-1,this.normals[t+1]*=-1,this.normals[t+2]*=-1,this.interleavedVertices[i]=this.normals[t],this.interleavedVertices[i+1]=this.normals[t+1],this.interleavedVertices[i+2]=this.normals[t+2];for(s=this.indices.length,t=0;t<s;t+=3)e=this.indices[t],this.indices[t]=this.indices[t+2],this.indices[t+2]=e;this.buildVbos()},getSideLength:function(){return 2*this.radius/Math.sqrt(3)},getTriangleCount:function(){return this.getIndexCount()/3},getIndexCount:function(){return this.indices.length},getVertexCount:function(){return this.vertices.length/3},getNormalCount:function(){return this.normals.length/3},getTexCoordCount:function(){return this.texCoords.length/2},toString:function(){return"===== Cubesphere =====\n        Radius: "+this.radius+"\n   Side Length: "+this.getSideLength().toFixed(5)+"\n   Subdivision: "+this.subdivision+"\n Smooth Shader: "+this.smooth+"\nTriangle Count: "+this.getTriangleCount()+"\n   Index Count: "+this.getIndexCount()+"\n  Vertex Count: "+this.getVertexCount()+"\n  Normal Count: "+this.getNormalCount()+"\nTexCoord Count: "+this.getTexCoordCount()+"\n"},clearArrays:function(){this.vertices.length=0,this.normals.length=0,this.texCoords.length=0,this.indices.length=0,this.interleavedVertices.length=0},resizeArraysSmooth:function(){this.clearArrays();let t=6*this.vertexCountPerRow*this.vertexCountPerRow;this.vertices=new Float32Array(3*t),this.normals=new Float32Array(3*t),this.texCoords=new Float32Array(2*t),this.indices=new Uint16Array(36*Math.pow(4,this.subdivision))},resizeArraysFlat:function(){this.clearArrays();let t=24*Math.pow(4,this.subdivision);this.vertices=new Float32Array(3*t),this.normals=new Float32Array(3*t),this.texCoords=new Float32Array(2*t),this.indices=new Uint16Array(36*Math.pow(4,this.subdivision))},buildVerticesSmooth:function(){let t,i,e,s,r,n,o,h,a,l,u,m,c,d=Smal.Cubesphere.getUnitPositiveX(this.vertexCountPerRow);for(this.resizeArraysSmooth(),u=m=c=h=0,n=0;n<this.vertexCountPerRow;++n)for(l=(a=n*this.vertexCountPerRow)+this.vertexCountPerRow,r=n/(this.vertexCountPerRow-1),o=0;o<this.vertexCountPerRow;++o,++a,++l)t=d[h],i=d[h+1],e=d[h+2],s=o/(this.vertexCountPerRow-1),this.addVertex(u,t*this.radius,i*this.radius,e*this.radius),this.addNormal(u,t,i,e),this.addTexCoord(m,s,r),n<this.vertexCountPerRow-1&&o<this.vertexCountPerRow-1&&(this.addIndices(c,a,l,a+1),c+=3,this.addIndices(c,a+1,l,l+1),c+=3),u+=3,m+=2,h+=3;let f,x=3*this.vertexCountPerRow*this.vertexCountPerRow,g=6*Math.pow(4,this.subdivision);for(n=0,o=0;n<x;n+=3,o+=2)this.addVertex(u,-this.vertices[n],this.vertices[n+1],-this.vertices[n+2]),this.addNormal(u,-this.normals[n],this.normals[n+1],-this.normals[n+2]),this.addTexCoord(m,this.texCoords[o],this.texCoords[o+1]),u+=3,m+=2;for(f=x/3,n=0;n<g;++n)this.indices[c]=f+this.indices[n],++c;for(n=0,o=0;n<x;n+=3,o+=2)this.addVertex(u,-this.vertices[n+2],this.vertices[n],-this.vertices[n+1]),this.addNormal(u,-this.normals[n+2],this.normals[n],-this.normals[n+1]),this.addTexCoord(m,this.texCoords[o],this.texCoords[o+1]),u+=3,m+=2;for(f=2*x/3,n=0;n<g;++n)this.indices[c]=f+this.indices[n],++c;for(n=0,o=0;n<x;n+=3,o+=2)this.addVertex(u,-this.vertices[n+2],-this.vertices[n],this.vertices[n+1]),this.addNormal(u,-this.normals[n+2],-this.normals[n],this.normals[n+1]),this.addTexCoord(m,this.texCoords[o],this.texCoords[o+1]),u+=3,m+=2;for(f=3*x/3,n=0;n<g;++n)this.indices[c]=f+this.indices[n],++c;for(n=0,o=0;n<x;n+=3,o+=2)this.addVertex(u,-this.vertices[n+2],this.vertices[n+1],this.vertices[n]),this.addNormal(u,-this.normals[n+2],this.normals[n+1],this.normals[n]),this.addTexCoord(m,this.texCoords[o],this.texCoords[o+1]),u+=3,m+=2;for(f=4*x/3,n=0;n<g;++n)this.indices[c]=f+this.indices[n],++c;for(n=0,o=0;n<x;n+=3,o+=2)this.addVertex(u,this.vertices[n+2],this.vertices[n+1],-this.vertices[n]),this.addNormal(u,this.normals[n+2],this.normals[n+1],-this.normals[n]),this.addTexCoord(m,this.texCoords[o],this.texCoords[o+1]),u+=3,m+=2;for(f=5*x/3,n=0;n<g;++n)this.indices[c]=f+this.indices[n],++c;this.buildInterleavedVertices(),this.buildVbos()},buildVerticesFlat:function(){let t,i,e,s,r,n,o,h,a,l,u=Smal.Cubesphere.getUnitPositiveX(this.vertexCountPerRow);this.resizeArraysFlat();let m=[],c=[],d=[],f=[],x=[],g=[],C=[],A=[],S=[];for(h=a=l=e=0,t=0;t<this.vertexCountPerRow-1;++t)for(r=(s=t*this.vertexCountPerRow)+this.vertexCountPerRow,x[1]=C[1]=t/(this.vertexCountPerRow-1),g[1]=A[1]=(t+1)/(this.vertexCountPerRow-1),i=0;i<this.vertexCountPerRow-1;++i,++s,++r)n=3*s,o=3*r,m[0]=u[n],m[1]=u[n+1],m[2]=u[n+2],c[0]=u[o],c[1]=u[o+1],c[2]=u[o+2],d[0]=u[n+3],d[1]=u[n+4],d[2]=u[n+5],f[0]=u[o+3],f[1]=u[o+4],f[2]=u[o+5],S=Smal.Cubesphere.computeFaceNormal(m,c,d),Smal.Cubesphere.scaleVertex(m,this.radius),Smal.Cubesphere.scaleVertex(c,this.radius),Smal.Cubesphere.scaleVertex(d,this.radius),Smal.Cubesphere.scaleVertex(f,this.radius),x[0]=g[0]=i/(this.vertexCountPerRow-1),C[0]=A[0]=(i+1)/(this.vertexCountPerRow-1),this.addVertex(h,m[0],m[1],m[2]),this.addNormal(h,S[0],S[1],S[2]),h+=3,this.addVertex(h,c[0],c[1],c[2]),this.addNormal(h,S[0],S[1],S[2]),h+=3,this.addVertex(h,d[0],d[1],d[2]),this.addNormal(h,S[0],S[1],S[2]),h+=3,this.addVertex(h,f[0],f[1],f[2]),this.addNormal(h,S[0],S[1],S[2]),h+=3,this.addTexCoord(a,x[0],x[1]),a+=2,this.addTexCoord(a,g[0],g[1]),a+=2,this.addTexCoord(a,C[0],C[1]),a+=2,this.addTexCoord(a,A[0],A[1]),a+=2,this.addIndices(l,e,e+1,e+2),l+=3,this.addIndices(l,e+2,e+1,e+3),l+=3,e+=4;let p,R=12*Math.pow(4,this.subdivision),T=6*Math.pow(4,this.subdivision);for(t=0,i=0;t<R;t+=3,i+=2)this.addVertex(h,-this.vertices[t],this.vertices[t+1],-this.vertices[t+2]),this.addNormal(h,-this.normals[t],this.normals[t+1],-this.normals[t+2]),this.addTexCoord(a,this.texCoords[i],this.texCoords[i+1]),h+=3,a+=2;for(p=R/3,t=0;t<T;++t)this.indices[l]=p+this.indices[t],++l;for(t=0,i=0;t<R;t+=3,i+=2)this.addVertex(h,-this.vertices[t+2],this.vertices[t],-this.vertices[t+1]),this.addNormal(h,-this.normals[t+2],this.normals[t],-this.normals[t+1]),this.addTexCoord(a,this.texCoords[i],this.texCoords[i+1]),h+=3,a+=2;for(p=2*R/3,t=0;t<T;++t)this.indices[l]=p+this.indices[t],++l;for(t=0,i=0;t<R;t+=3,i+=2)this.addVertex(h,-this.vertices[t+2],-this.vertices[t],this.vertices[t+1]),this.addNormal(h,-this.normals[t+2],-this.normals[t],this.normals[t+1]),this.addTexCoord(a,this.texCoords[i],this.texCoords[i+1]),h+=3,a+=2;for(p=3*R/3,t=0;t<T;++t)this.indices[l]=p+this.indices[t],++l;for(t=0,i=0;t<R;t+=3,i+=2)this.addVertex(h,-this.vertices[t+2],this.vertices[t+1],this.vertices[t]),this.addNormal(h,-this.normals[t+2],this.normals[t+1],this.normals[t]),this.addTexCoord(a,this.texCoords[i],this.texCoords[i+1]),h+=3,a+=2;for(p=4*R/3,t=0;t<T;++t)this.indices[l]=p+this.indices[t],++l;for(t=0,i=0;t<R;t+=3,i+=2)this.addVertex(h,this.vertices[t+2],this.vertices[t+1],-this.vertices[t]),this.addNormal(h,this.normals[t+2],this.normals[t+1],-this.normals[t]),this.addTexCoord(a,this.texCoords[i],this.texCoords[i+1]),h+=3,a+=2;for(p=5*R/3,t=0;t<T;++t)this.indices[l]=p+this.indices[t],++l;this.buildInterleavedVertices(),this.buildVbos()},buildInterleavedVertices:function(){let t,i,e,s=this.getVertexCount();for(this.interleavedVertices.length=0,this.interleavedVertices=new Float32Array(8*s),t=0,i=0,e=0;t<this.vertices.length;t+=3,i+=2,e+=8)this.interleavedVertices[e]=this.vertices[t],this.interleavedVertices[e+1]=this.vertices[t+1],this.interleavedVertices[e+2]=this.vertices[t+2],this.interleavedVertices[e+3]=this.normals[t],this.interleavedVertices[e+4]=this.normals[t+1],this.interleavedVertices[e+5]=this.normals[t+2],this.interleavedVertices[e+6]=this.texCoords[i],this.interleavedVertices[e+7]=this.texCoords[i+1]},buildVbos:function(){let t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,this.vboVertex),t.bufferData(t.ARRAY_BUFFER,this.interleavedVertices,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.vboIndex),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)},addVertex:function(t,i,e,s){this.vertices[t]=i,this.vertices[t+1]=e,this.vertices[t+2]=s},addNormal:function(t,i,e,s){this.normals[t]=i,this.normals[t+1]=e,this.normals[t+2]=s},addTexCoord:function(t,i,e){this.texCoords[t]=i,this.texCoords[t+1]=e},addIndices:function(t,i,e,s){this.indices[t]=i,this.indices[t+1]=e,this.indices[t+2]=s}},Smal.Cubesphere.computeScaleForLength=function(t,i,e,s){return s/Math.sqrt(t*t+i*i+e*e)},Smal.Cubesphere.getUnitPositiveX=function(t){const i=Math.acos(-1)/180;let e,s,r,n,o,h,a=new Float32Array(3*t*t),l=new Float32Array(3),u=new Float32Array(3),m=new Float32Array(3);for(h=0,n=0;n<t;++n)for(s=i*(45-90*n/(t-1)),u[0]=-Math.sin(s),u[1]=Math.cos(s),u[2]=0,o=0;o<t;++o)e=i*(90*o/(t-1)-45),l[0]=-Math.sin(e),l[1]=0,l[2]=-Math.cos(e),m[0]=l[1]*u[2]-l[2]*u[1],m[1]=l[2]*u[0]-l[0]*u[2],m[2]=l[0]*u[1]-l[1]*u[0],r=Smal.Cubesphere.computeScaleForLength(m[0],m[1],m[2],1),Smal.Cubesphere.scaleVertex(m,r),a[h]=m[0],a[h+1]=m[1],a[h+2]=m[2],h+=3;return a},Smal.Cubesphere.computeFaceNormal=function(t,i,e){let s=new Float32Array(3),r=i[0]-t[0],n=i[1]-t[1],o=i[2]-t[2],h=e[0]-t[0],a=e[1]-t[1],l=e[2]-t[2],u=n*l-o*a,m=o*h-r*l,c=r*a-n*h,d=Math.sqrt(u*u+m*m+c*c);return d>1e-6&&(s[0]=u/d,s[1]=m/d,s[2]=c/d),s},Smal.Cubesphere.scaleVertex=function(t,i){t[0]*=i,t[1]*=i,t[2]*=i},Smal.Cone=function(t,i=1,e=1,s=36,r=1,n=!0){this.gl=t,t||log("[WARNING] Smal.Cone.contructor requires GL context as a param."),this.baseRadius=i,this.height=e,this.sectorCount=s,this.stackCount=r,this.smooth=n,this.apexNormalMode=0,this.unitCircleVertices=[],this.vertices=[],this.normals=[],this.texCoords=[],this.indices=[],this.interleavedVertices=[],this.stride=32,t&&(this.vboVertex=t.createBuffer(),this.vboIndex=t.createBuffer()),this.buildUnitCircleVertices(),this.smooth?this.buildVerticesSmooth():this.buildVerticesFlat()},Smal.Cone.prototype={set:function(t,i,e,s,r){return this.baseRadius=t,this.height=i,this.sectorCount=e,this.stackCount=s,this.smooth=r,this.buildUnitCircleVertices(),this.smooth?this.buildVerticesSmooth():this.buildVerticesFlat(),this},setBaseRadius:function(t){return this.baseRadius!=t&&this.set(t,this.height,this.sectorCount,this.stackCount,this.smooth),this},setHeight:function(t){return this.height!=t&&this.set(this.baseRadius,t,this.sectorCount,this.stackCount,this.smooth),this},setSectorCount:function(t){return this.sectorCount!=t&&this.set(this.baseRadius,this.height,t,this.stackCount,this.smooth),this},setStackCount:function(t){return this.stackCount!=t&&this.set(this.baseRadius,this.height,this.sectorCount,t,this.smooth),this},setSmooth:function(t){return this.smooth!=t&&(this.smooth=t,this.smooth?this.buildVerticesSmooth():this.buildVerticesFlat()),this},setApexNormalMode:function(t){this.apexNormalMode!=t&&t<3&&(this.apexNormalMode=t,this.smooth&&this.buildVerticesSmooth())},reverseNormals:function(){let t,i,e,s=this.normals.length;for(t=0,i=3;t<s;t+=3,i+=8)this.normals[t]*=-1,this.normals[t+1]*=-1,this.normals[t+2]*=-1,this.interleavedVertices[i]=this.normals[t],this.interleavedVertices[i+1]=this.normals[t+1],this.interleavedVertices[i+2]=this.normals[t+2];for(s=this.indices.length,t=0;t<s;t+=3)e=this.indices[t],this.indices[t]=this.indices[t+2],this.indices[t+2]=e;this.buildVbos()},getTriangleCount:function(){return this.getIndexCount()/3},getIndexCount:function(){return this.indices.length},getVertexCount:function(){return this.vertices.length/3},getNormalCount:function(){return this.normals.length/3},getTexCoordCount:function(){return this.texCoords.length/2},toString:function(){return"===== Cone =====\n   Base Radius: "+this.baseRadius+"\n        Height: "+this.height+"\n  Sector Count: "+this.sectorCount+"\n   Stack Count: "+this.stackCount+"\n Smooth Shader: "+this.smooth+"\nTriangle Count: "+this.getTriangleCount()+"\n   Index Count: "+this.getIndexCount()+"\n  Vertex Count: "+this.getVertexCount()+"\n  Normal Count: "+this.getNormalCount()+"\nTexCoord Count: "+this.getTexCoordCount()+"\n"},clearArrays:function(){this.vertices.length=0,this.normals.length=0,this.texCoords.length=0,this.indices.length=0,this.interleavedVertices.length=0},resizeArraysSmooth:function(){this.clearArrays();let t=(this.sectorCount+1)*(this.stackCount+1),i=this.sectorCount+1;this.vertices=new Float32Array(3*(t+i)),this.normals=new Float32Array(3*(t+i)),this.texCoords=new Float32Array(2*(t+i)),this.indices=new Uint16Array(6*this.sectorCount*this.stackCount)},resizeArraysFlat:function(){this.clearArrays();let t=4*this.sectorCount*this.stackCount,i=this.sectorCount+1;this.vertices=new Float32Array(3*(t+i)),this.normals=new Float32Array(3*(t+i)),this.texCoords=new Float32Array(2*(t+i)),this.indices=new Uint16Array(6*this.sectorCount*this.stackCount)},buildUnitCircleVertices:function(){let t=2*Math.PI/this.sectorCount,i=0;this.unitCircleVertices.length=0,this.unitCircleVertices=new Float32Array(3*(this.sectorCount+1));for(let e=0,s=0;e<=this.sectorCount;++e,s+=3)i=e*t,this.unitCircleVertices[s]=Math.cos(i),this.unitCircleVertices[s+1]=Math.sin(i),this.unitCircleVertices[s+2]=0},buildVerticesSmooth:function(){let t,i,e,s,r,n,o,h,a,l,u;this.resizeArraysSmooth();let m=0,c=0,d=0,f=this.getSideNormals(),x=this.getApexNormals();for(o=0;o<=this.stackCount;++o)for(e=-.5*this.height+o/this.stackCount*this.height,s=this.baseRadius*(1-o/this.stackCount),n=1-o/this.stackCount,h=0,a=0;h<=this.sectorCount;++h,a+=3)o<this.stackCount?(t=this.unitCircleVertices[a],i=this.unitCircleVertices[a+1],this.addVertex(m,t*s,i*s,e),this.addNormal(m,f[a],f[a+1],f[a+2])):(this.addVertex(m,0,0,e),this.addNormal(m,x[a],x[a+1],x[a+2])),r=h/this.sectorCount,this.addTexCoord(c,r,n),m+=3,c+=2;let g=m/3;for(e=.5*-this.height,this.addVertex(m,0,0,e),this.addNormal(m,0,0,-1),this.addTexCoord(c,.5,.5),m+=3,c+=2,o=0,h=0;o<this.sectorCount;++o,h+=3)t=this.unitCircleVertices[h],i=this.unitCircleVertices[h+1],this.addVertex(m,t*this.baseRadius,i*this.baseRadius,e),this.addNormal(m,0,0,-1),this.addTexCoord(c,.5*-t+.5,.5*-i+.5),m+=3,c+=2;for(o=0;o<this.stackCount;++o)for(u=(l=o*(this.sectorCount+1))+this.sectorCount+1,h=0;h<this.sectorCount;++h,++l,++u)o<this.stackCount-1?(this.addIndices(d,l,l+1,u),this.addIndices(d+3,u,l+1,u+1),d+=6):(this.addIndices(d,l,l+1,u),d+=3);for(o=0,a=g+1;o<this.sectorCount;++o,++a)o<this.sectorCount-1?this.addIndices(d,g,a+1,a):this.addIndices(d,g,g+1,a),d+=3;this.buildInterleavedVertices(),this.buildVbos()},buildVerticesFlat:function(){let t,i,e,s,r,n,o,h,a,u,c,d,f,x,g,C,A,S=[],p={};for(t=0,m=0;t<=this.stackCount;++t)for(n=-.5*this.height+t/this.stackCount*this.height,o=this.baseRadius*(1-t/this.stackCount),h=1-t/this.stackCount,i=0,e=0,l=0;i<=this.sectorCount;++i,e+=3,l+=2)p={x:(s=this.unitCircleVertices[e])*o,y:(r=this.unitCircleVertices[e+1])*o,z:n,s:i/this.sectorCount,t:h},S.push(p);for(this.resizeArraysFlat(),g=C=A=x=0,t=0;t<this.stackCount;++t)for(vi1=t*(this.sectorCount+1),vi2=(t+1)*(this.sectorCount+1),i=0;i<this.sectorCount;++i,++vi1,++vi2){for(a=S[vi1],u=S[vi2],c=S[vi1+1],d=S[vi2+1],this.addVertex(g,a.x,a.y,a.z),this.addVertex(g+3,u.x,u.y,u.z),this.addVertex(g+6,c.x,c.y,c.z),this.addVertex(g+9,d.x,d.y,d.z),this.addTexCoord(C,a.s,a.t),this.addTexCoord(C+2,u.s,u.t),this.addTexCoord(C+4,c.s,c.t),this.addTexCoord(C+6,d.s,d.t),f=Smal.Cone.computeFaceNormal(a.x,a.y,a.z,c.x,c.y,c.z,u.x,u.y,u.z),e=0;e<4;++e)this.addNormal(g+3*e,f[0],f[1],f[2]);g+=12,C+=8,t<this.stackCount-1?(this.addIndices(A,x,x+2,x+1),this.addIndices(A+3,x+1,x+2,x+3),A+=6,x+=4):(this.addIndices(A,x,x+2,x+1),A+=3,x+=4)}let R=g/3;for(n=.5*-this.height,this.addVertex(g,0,0,n),this.addNormal(g,0,0,-1),this.addTexCoord(C,.5,.5),g+=3,C+=2,t=0,i=0;t<this.sectorCount;++t,i+=3)s=this.unitCircleVertices[i],r=this.unitCircleVertices[i+1],this.addVertex(g,s*this.baseRadius,r*this.baseRadius,n),this.addNormal(g,0,0,-1),this.addTexCoord(C,.5*-s+.5,.5*-r+.5),g+=3,C+=2;for(t=0,e=R+1;t<this.sectorCount;++t,++e)t<this.sectorCount-1?this.addIndices(A,R,e+1,e):this.addIndices(A,R,R+1,e),A+=3;this.buildInterleavedVertices(),this.buildVbos()},buildInterleavedVertices:function(){let t,i,e,s=this.getVertexCount();for(this.interleavedVertices.length=0,this.interleavedVertices=new Float32Array(8*s),t=0,i=0,e=0;t<this.vertices.length;t+=3,i+=2,e+=8)this.interleavedVertices[e]=this.vertices[t],this.interleavedVertices[e+1]=this.vertices[t+1],this.interleavedVertices[e+2]=this.vertices[t+2],this.interleavedVertices[e+3]=this.normals[t],this.interleavedVertices[e+4]=this.normals[t+1],this.interleavedVertices[e+5]=this.normals[t+2],this.interleavedVertices[e+6]=this.texCoords[i],this.interleavedVertices[e+7]=this.texCoords[i+1]},buildVbos:function(){let t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,this.vboVertex),t.bufferData(t.ARRAY_BUFFER,this.interleavedVertices,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.vboIndex),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)},getSideNormals:function(){let t=2*Math.PI/this.sectorCount,i=0,e=Math.atan2(this.baseRadius,this.height),s=Math.cos(e),r=Math.sin(e),n=new Float32Array(3*(this.sectorCount+1));for(let e=0,o=0;e<=this.sectorCount;++e,o+=3)i=e*t,n[o]=Math.cos(i)*s,n[o+1]=Math.sin(i)*s,n[o+2]=r;return n},getApexNormals:function(){let t=2*Math.PI/this.sectorCount,i=0,e=Math.atan2(this.baseRadius,this.height),s=Math.cos(e),r=Math.sin(e),n=new Float32Array(3*(this.sectorCount+1));for(let e=0,o=0;e<=this.sectorCount;++e,o+=3)0==this.apexNormalMode?(i=e*t,n[o]=Math.cos(i)*s,n[o+1]=Math.sin(i)*s,n[o+2]=r):1==this.apexNormalMode?(n[o]=0,n[o+1]=0,n[o+2]=1):2==this.apexNormalMode&&(n[o]=0,n[o+1]=0,n[o+2]=0);return n},addVertex:function(t,i,e,s){this.vertices[t]=i,this.vertices[t+1]=e,this.vertices[t+2]=s},addNormal:function(t,i,e,s){this.normals[t]=i,this.normals[t+1]=e,this.normals[t+2]=s},addTexCoord:function(t,i,e){this.texCoords[t]=i,this.texCoords[t+1]=e},addIndices:function(t,i,e,s){this.indices[t]=i,this.indices[t+1]=e,this.indices[t+2]=s}},Smal.Cone.computeFaceNormal=function(t,i,e,s,r,n,o,h,a){let l=new Float32Array(3),u=s-t,m=r-i,c=n-e,d=o-t,f=h-i,x=a-e,g=m*x-c*f,C=c*d-u*x,A=u*f-m*d,S=Math.sqrt(g*g+C*C+A*A);return S>1e-6&&(l[0]=g/S,l[1]=C/S,l[2]=A/S),l},Smal.Torus=function(t,i=1,e=.5,s=36,r=18,n=!0){this.gl=t,t||log("[WARNING] Smal.Torus.contructor requires GL context as a param."),this.majorRadius=1,this.minorRadius=.5,this.sectorCount=36,this.sideCount=18,this.smooth=!0,this.vertices=[],this.normals=[],this.texCoords=[],this.indices=[],this.interleavedVertices=[],this.stride=32,t&&(this.vboVertex=t.createBuffer(),this.vboIndex=t.createBuffer()),this.set(i,e,s,r,n)},Smal.Torus.prototype={set:function(t,i,e,s,r){return this.majorRadius=t,this.minorRadius=i,this.sectorCount=e,e<3&&(this.sectorCount=3),this.sideCount=s,s<3&&(this.sideCount=3),this.smooth=r,r?this.buildVerticesSmooth():this.buildVerticesFlat(),this},setMajorRadius:function(t){return this.majorRadius!=t&&this.set(t,this.minorRadius,this.sectorCount,this.sideCount,this.smooth),this},setMinorRadius:function(t){return this.minorRadius!=t&&this.set(this.majorRadius,t,this.sectorCount,this.sideCount,this.smooth),this},setSectorCount:function(t){return this.sectorCount!=t&&this.set(this.majorRadius,this.minorRadius,t,this.sideCount,this.smooth),this},setSideCount:function(t){return this.sideCount!=t&&this.set(this.majorRadius,this.minorRadius,this.sectorCount,t,this.smooth),this},setSmooth:function(t){return this.smooth!=t&&(this.smooth=t,this.smooth?this.buildVerticesSmooth():this.buildVerticesFlat()),this},reverseNormals:function(){let t,i,e,s=this.normals.length;for(t=0,i=3;t<s;t+=3,i+=8)this.normals[t]*=-1,this.normals[t+1]*=-1,this.normals[t+2]*=-1,this.interleavedVertices[i]=this.normals[t],this.interleavedVertices[i+1]=this.normals[t+1],this.interleavedVertices[i+2]=this.normals[t+2];for(s=this.indices.length,t=0;t<s;t+=3)e=this.indices[t],this.indices[t]=this.indices[t+2],this.indices[t+2]=e;this.buildVbos()},getTriangleCount:function(){return this.getIndexCount()/3},getIndexCount:function(){return this.indices.length},getVertexCount:function(){return this.vertices.length/3},getNormalCount:function(){return this.normals.length/3},getTexCoordCount:function(){return this.texCoords.length/2},toString:function(){return"===== Torus =====\n  Major Radius: "+this.majorRadius+"\n  Minor Radius: "+this.minorRadius+"\n  Sector Count: "+this.sectorCount+"\n    Side Count: "+this.sideCount+"\n Smooth Shader: "+this.smooth+"\nTriangle Count: "+this.getTriangleCount()+"\n   Index Count: "+this.getIndexCount()+"\n  Vertex Count: "+this.getVertexCount()+"\n  Normal Count: "+this.getNormalCount()+"\nTexCoord Count: "+this.getTexCoordCount()+"\n"},clearArrays:function(){this.vertices.length=0,this.normals.length=0,this.texCoords.length=0,this.indices.length=0,this.interleavedVertices.length=0},resizeArraysSmooth:function(){this.clearArrays();let t=(this.sectorCount+1)*(this.sideCount+1);this.vertices=new Float32Array(3*t),this.normals=new Float32Array(3*t),this.texCoords=new Float32Array(2*t),this.indices=new Uint16Array(6*this.sectorCount*this.sideCount)},resizeArraysFlat:function(){this.clearArrays();let t=4*this.sectorCount*this.sideCount;this.vertices=new Float32Array(3*t),this.normals=new Float32Array(3*t),this.texCoords=new Float32Array(2*t),this.indices=new Uint16Array(6*this.sectorCount*this.sideCount)},buildVerticesSmooth:function(){let t,i,e,s,r,n,o,h,a,l,u,m,c,d,f,x;this.resizeArraysSmooth();let g,C,A=1/this.minorRadius,S=2*Math.PI/this.sectorCount,p=2*Math.PI/this.sideCount;for(d=f=x=0,l=0;l<=this.sideCount;++l)for(C=Math.PI-l*p,s=this.minorRadius*Math.cos(C),e=this.minorRadius*Math.sin(C),u=0;u<=this.sectorCount;++u)g=u*S,r=(t=s*Math.cos(g))*A,n=(i=s*Math.sin(g))*A,o=e*A,this.addNormal(d,r,n,o),t+=this.majorRadius*Math.cos(g),i+=this.majorRadius*Math.sin(g),this.addVertex(d,t,i,e),h=u/this.sectorCount,a=l/this.sideCount,this.addTexCoord(f,h,a),d+=3,f+=2;for(l=0;l<this.sideCount;++l)for(c=(m=l*(this.sectorCount+1))+this.sectorCount+1,u=0;u<this.sectorCount;++u,++m,++c)this.addIndices(x,m,c,m+1),x+=3,this.addIndices(x,m+1,c,c+1),x+=3;this.buildInterleavedVertices(),this.buildVbos()},buildVerticesFlat:function(){let t,i,e,s,r,n,o,h,a,l,u,m,c,d,f,x,g,C=2*Math.PI/this.sectorCount,A=2*Math.PI/this.sideCount,S=[],p={};for(t=0;t<=this.sideCount;++t)for(g=Math.PI-t*A,r=this.majorRadius+this.minorRadius*Math.cos(g),e=this.minorRadius*Math.sin(g),i=0;i<=this.sectorCount;++i)x=i*C,p={x:r*Math.cos(x),y:r*Math.sin(x),z:e,s:i/this.sectorCount,t:t/this.sideCount},S.push(p);for(this.resizeArraysFlat(),c=d=f=m=0,t=0;t<this.sideCount;++t)for(l=t*(this.sectorCount+1),u=(t+1)*(this.sectorCount+1),i=0;i<this.sectorCount;++i,++l,++u)n=S[l],o=S[u],h=S[l+1],a=S[u+1],this.addVertex(c,n.x,n.y,n.z),this.addVertex(c+3,o.x,o.y,o.z),this.addVertex(c+6,h.x,h.y,h.z),this.addVertex(c+9,a.x,a.y,a.z),this.addTexCoord(d,n.s,n.t),this.addTexCoord(d+2,o.s,o.t),this.addTexCoord(d+4,h.s,h.t),this.addTexCoord(d+6,a.s,a.t),s=Smal.Torus.computeFaceNormal(n.x,n.y,n.z,o.x,o.y,o.z,h.x,h.y,h.z),this.addNormal(c,s[0],s[1],s[2]),this.addNormal(c+3,s[0],s[1],s[2]),this.addNormal(c+6,s[0],s[1],s[2]),this.addNormal(c+9,s[0],s[1],s[2]),this.addIndices(f,m,m+1,m+2),this.addIndices(f+3,m+2,m+1,m+3),c+=12,d+=8,f+=6,m+=4;this.buildInterleavedVertices(),this.buildVbos()},buildInterleavedVertices:function(){let t,i,e,s=this.getVertexCount();for(this.interleavedVertices.length=0,this.interleavedVertices=new Float32Array(8*s),t=0,i=0,e=0;t<this.vertices.length;t+=3,i+=2,e+=8)this.interleavedVertices[e]=this.vertices[t],this.interleavedVertices[e+1]=this.vertices[t+1],this.interleavedVertices[e+2]=this.vertices[t+2],this.interleavedVertices[e+3]=this.normals[t],this.interleavedVertices[e+4]=this.normals[t+1],this.interleavedVertices[e+5]=this.normals[t+2],this.interleavedVertices[e+6]=this.texCoords[i],this.interleavedVertices[e+7]=this.texCoords[i+1]},buildVbos:function(){let t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,this.vboVertex),t.bufferData(t.ARRAY_BUFFER,this.interleavedVertices,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.vboIndex),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)},addVertex:function(t,i,e,s){this.vertices[t]=i,this.vertices[t+1]=e,this.vertices[t+2]=s},addNormal:function(t,i,e,s){this.normals[t]=i,this.normals[t+1]=e,this.normals[t+2]=s},addTexCoord:function(t,i,e){this.texCoords[t]=i,this.texCoords[t+1]=e},addIndices:function(t,i,e,s){this.indices[t]=i,this.indices[t+1]=e,this.indices[t+2]=s}},Smal.Torus.computeFaceNormal=function(t,i,e,s,r,n,o,h,a){let l=new Float32Array(3),u=s-t,m=r-i,c=n-e,d=o-t,f=h-i,x=a-e,g=m*x-c*f,C=c*d-u*x,A=u*f-m*d,S=Math.sqrt(g*g+C*C+A*A);return S>1e-6&&(l[0]=g/S,l[1]=C/S,l[2]=A/S),l},Smal.defaultTextureData=new Uint8Array([255,255,255,255]),Smal.defaultNormalmapData=new Uint8Array([127,127,255,255]),Smal.defaultOcclusionmapData=new Uint8Array([255]),Smal.isWebGLSupported=function(){return!!window.WebGLRenderingContext},Smal.getContextGL=function(t,e){let s=null,r=["webgl","experimental-webgl","moz-webgl","webkit-3d"];for(i=0;i<r.length;++i)try{if(s=t.getContext(r[i],e))break}catch(t){}return s||(log("[ERROR] Failed to get WebGL rendering context."),alert("[ERROR] Failed to get WebGL context.")),s},Smal.getRequestAnimationFrameFunction=function(t){let i=Smal.getAvailableFunctionFromList(t,["requestAnimationFrame","mozRequestAnimationFrame","msRequestAnimationFrame","oRequestAnimationFrame","webkitRequestAnimationFrame"]);return i?function(e){return t[i](e)}:function(t){return setTimeout(t,16)}},Smal.getCancelAnimationFrameFunction=function(t){let i=Smal.getAvailableFunctionFromList(t,["cancelAnimationFrame","mozCancelAnimationFrame","msCancelAnimationFrame","oCancelAnimationFrame","webkitCancelAnimationFrame"]);return i?function(e){return t[i](e)}:function(t){return clearTimeout(t)}},Smal.getAnimationStartTimeFunction=function(t){let i=Smal.getAvailableFunctionFromList(t,["animationStartTime","mozAnimationStartTime","msAnimationStartTime","oAnimationStartTime","webkitAnimationStartTime"]);return i?function(){return t[i]}:function(){return Date.now()}},Smal.getAvailableFunctionFromList=function(t,i){if(!t)return null;for(let e=0,s=i.length;e<s;++e){let s=i[e];if(t[s])return s}return null},Smal.loadShaderById=function(t,i){let e=document.getElementById(i);if(!e)return log("[WARNING] Cannot load GLSL shader source. The source ID is NULL."),null;let s,r="",n=e.firstChild;for(;n;)3==n.nodeType&&(r+=n.textContent),n=n.nextSibling;if("x-shader/x-vertex"==e.type)s=t.createShader(t.VERTEX_SHADER);else{if("x-shader/x-fragment"!=e.type)return null;s=t.createShader(t.FRAGMENT_SHADER)}return t.shaderSource(s,r),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)?s:(log("[ERROR] "+t.getShaderInfoLog(s)),null)},Smal.createShaderProgram=function(t,i,e){let s=[i,e];return Promise.all(s.map(Smal.loadFile)).then(i=>{let e=t.createShader(t.VERTEX_SHADER),s=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(e,i[0]),t.compileShader(e),!t.getShaderParameter(e,t.COMPILE_STATUS))return log("[ERROR] Vetex Shader: "+t.getShaderInfoLog(e)),null;if(t.shaderSource(s,i[1]),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))return log("[ERROR] Fragment Shader: "+t.getShaderInfoLog(s)),null;let r=t.createProgram();return r.uniform={},r.attribute={},t.attachShader(r,e),t.attachShader(r,s),t.deleteShader(e),t.deleteShader(s),t.linkProgram(r),t.getProgramParameter(r,t.LINK_STATUS)?(Smal.addUniformLocations(t,r),Smal.addAttributeLocations(t,r),r):(log("[ERROR] Failed to link GLSL: "+t.getProgramInfoLog(r)),null)})},Smal.addUniformLocations=function(t,i){let e,s=t.getProgramParameter(i,t.ACTIVE_UNIFORMS);for(e=0;e<s;++e){let s,r,n,o=t.getActiveUniform(i,e),h=o.name.indexOf("."),a=o.name.indexOf("[");if(h>=0)s=o.name.substring(0,h),r=o.name.substring(h+1),void 0===i.uniform[s]&&(i.uniform[s]={}),i.uniform[s][r]=t.getUniformLocation(i,o.name);else if(a>=0){n=o.name.substring(0,a),i.uniform[n]=t.getUniformLocation(i,n),i.uniform[n][0]=t.getUniformLocation(i,o.name);let e=1,s=!0;for(;s;)r=n+"["+e+"]",i.uniform[n][e]=t.getUniformLocation(i,r),i.uniform[n][e]||(s=!1),++e}else i.uniform[o.name]=t.getUniformLocation(i,o.name)}},Smal.addAttributeLocations=function(t,i){let e=t.getProgramParameter(i,t.ACTIVE_ATTRIBUTES);for(let s=0;s<e;++s){let e=t.getActiveAttrib(i,s);i.attribute[e.name]=t.getAttribLocation(i,e.name)}},Smal.initVertexAttribArrays=function(t){t.dummyBuffer=new Float32Array([0,0,0]),t.vboDummy=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,t.vboDummy),t.bufferData(t.ARRAY_BUFFER,t.dummyBuffer,t.STATIC_DRAW);let i=t.getParameter(t.MAX_VERTEX_ATTRIBS);for(let e=0;e<i;++e)t.enableVertexAttribArray(e),t.vertexAttribPointer(e,3,t.FLOAT,!1,0,0)},Smal.loadTexture=function(t,i,e,s){let r=t.createTexture();Smal.setupDefaultTexture(t,r);let n=new Image;return n.src=i,n.crossOrigin="anonymous",n.onload=function(){Smal.setupTexture(t,r,n,e),s&&s(r)},n.onerror=function(){log("[ERROR] Failed to load texture "+i.substring(i.lastIndexOf("/")+1)),s&&s(null)},r},Smal.loadNormalmap=function(t,i,e,s){let r=t.createTexture();Smal.setupDefaultTexture(t,r,Smal.TextureType.NORMALMAP);let n=new Image;return n.src=i,n.crossOrigin="anonymous",n.onload=function(){Smal.setupTexture(t,r,n,e),s&&s(r)},n.onerror=function(){s&&s(null),log("[ERROR] Failed to load a normalmap "+i.substring(i.lastIndexOf("/")+1))},r},Smal.loadOcclusionmap=function(t,i,e,s){let r=t.createTexture();Smal.setupDefaultTexture(t,r,Smal.TextureType.OCCLUSIONMAP);let n=new Image;return n.src=i,n.crossOrigin="anonymous",n.onload=function(){Smal.setupTexture(t,r,n,e,Smal.TextureType.OCCLUSIONMAP),s&&s(r)},n.onerror=function(){s&&s(null),log("[ERROR] Failed to load an occlusionmap "+i.substring(i.lastIndexOf("/")+1))},r},Smal.loadCubemap=function(t,i,e){let s=i.lastIndexOf("."),r=i.substring(0,s),n=i.substring(s),o=t.createTexture();Smal.setupDefaultTexture(t,o,Smal.TextureType.CUBEMAP);for(let i=0;i<6;++i){let s=r+i+n,h=new Image;h.src=s,h.crossOrigin="anonymous",h.onload=function(){Smal.setupCubemap(t,o,h,i),e&&e(o,i)},h.onerror=function(){e&&e(null,i),log("[ERROR] Failed to load a cubemap "+s.substring(s.lastIndexOf("/")+1))}}return o},Smal.setupTexture=function(t,i,e,s,r){let n=t.RGBA;r==Smal.TextureType.OCCLUSIONMAP&&(n=t.LUMINANCE),t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,n,n,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),1==s?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)},Smal.setupCubemap=function(t,i,e,s){t.bindTexture(t.TEXTURE_CUBE_MAP,i),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,t.RGB,t.RGB,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.generateMipmap(t.TEXTURE_CUBE_MAP),t.bindTexture(t.TEXTURE_CUBE_MAP,null)},Smal.setupDefaultTexture=function(t,i,e){let s=t.RGBA,r=Smal.defaultTextureData;if(e==Smal.TextureType.NORMALMAP)r=Smal.defaultNormalmapData;else if(e==Smal.TextureType.OCCLUSIONMAP)r=Smal.defaultOcclusionmapData,s=t.LUMINANCE;else if(e==Smal.TextureType.CUBEMAP){t.bindTexture(t.TEXTURE_CUBE_MAP,i);for(let i=0;i<6;++i)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,s,1,1,0,s,t.UNSIGNED_BYTE,r),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.REPEAT);return void t.bindTexture(t.TEXTURE_CUBE_MAP,null)}t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,s,1,1,0,s,t.UNSIGNED_BYTE,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null)},Smal.loadFile=function(t){return new Promise((i,e)=>{let s=t.substring(t.lastIndexOf("/")+1),r=new XMLHttpRequest;r.open("GET",t,!0),r.send(),r.onload=(()=>{if(200==r.status)i(r.response),log("Loaded file: "+s);else{let t="[ERROR] Failed to load file("+r.status+"): "+s;e(t),log(t)}}),r.onerror=(()=>e("[ERROR] Failed to load: "+s))})},Smal.getInterpolateAlpha=function(t,i){let e=t;if(i==Smal.AnimationMode.EASE_IN)e=t*t*t;else if(i==Smal.AnimationMode.EASE_IN2)e=1-Math.sqrt(1-t*t);else if(i==Smal.AnimationMode.EASE_OUT){let i=1-t;e=1-i*i*i}else if(i==Smal.AnimationMode.EASE_OUT2)e=Math.sqrt(1-(1-t)*(1-t));else if(i==Smal.AnimationMode.EASE_IN_OUT){let i=1-t,s=4;e=t<.5?t*t*t*s:1-i*i*i*s}else i==Smal.AnimationMode.EASE_IN_OUT2?e=t<.5?.5*(1-Math.sqrt(1-t*t)):.5*Math.sqrt(1-(1-t)*(1-t))+.5:i==Smal.AnimationMode.BOUNCE||Smal.AnimationMode.ELASTIC;return e},Smal.interpolate=function(t,i,e,s){return t+(i-t)*Smal.getInterpolateAlpha(e,s)},Smal.adjustSpeed=function(t,i,e,s,r){let n;return n=e>0?1:-1,t?n*(i+=n*s*r)>n*e&&(i=e):n*(i-=n*s*r)<0&&(i=0),i},Smal.slideTo=function(t,i,e,s,r,n,o,h){let a=document.getElementById(t);if(!a)return;h=h||function(){};let l={};l.left=parseInt(a.style.left),l.top=parseInt(a.style.top),l.width=parseInt(a.style.width),l.height=parseInt(a.style.height),l.time=Date.now();let u={};u.left=i,u.top=e,u.width=s,u.height=r,u.time=l.time+n,requestAnimationFrame(function t(){let i=Date.now();if(i>=u.time)return a.style.left=u.left+"px",a.style.top=u.top+"px",a.style.width=u.width+"px",a.style.height=u.height+"px",clearInterval(animId),void h();let e=(i-l.time)/n;let s=Math.round(Smal.interpolate(l.left,u.left,e,o));let r=Math.round(Smal.interpolate(l.top,u.top,e,o));let m=Math.round(Smal.interpolate(l.width,u.width,e,o));let c=Math.round(Smal.interpolate(l.height,u.height,e,o));a.style.left=s+"px";a.style.top=r+"px";a.style.width=m+"px";a.style.height=c+"px";requestAnimationFrame(t)})},Smal.rad2deg=function(t){return t/Math.PI*180},Smal.deg2rad=function(t){return t/180*Math.PI},Smal.getElementOffset=function(t){let i=0,e=0;for(;t;)i+=t.offsetLeft||0,e+=t.offsetTop||0,t=t.offsetParent;return{x:i,y:e}},Smal.getWindowWidth=function(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0},Smal.getWindowHeight=function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0},Smal.computeVolume=function(t,i){let e,s,r,n,o,h,a={},l={},u={},m=0;for(let c=0;c<i.length;c+=3)e=3*i[c],a.x=t[e],a.y=t[e+1],a.z=t[e+2],s=3*i[c+1],l.x=t[s],l.y=t[s+1],l.z=t[s+2],r=3*i[c+2],u.x=t[r],u.y=t[r+1],u.z=t[r+2],n=l.y*u.z-u.y*l.z,o=u.y*a.z-a.y*u.z,h=a.y*l.z-l.y*a.z,m+=a.x*n+l.x*o+u.x*h;return 1/6*m},Smal.computeArea=function(t,i){let e,s,r,n={},o={},h={},a={},l={},u={},m=0;for(let c=0;c<i.length;c+=3)e=3*i[c],n.x=t[e],n.y=t[e+1],n.z=t[e+2],s=3*i[c+1],o.x=t[s],o.y=t[s+1],o.z=t[s+2],r=3*i[c+2],h.x=t[r],h.y=t[r+1],h.z=t[r+2],a.x=o.x-n.x,a.y=o.y-n.y,a.z=o.z-n.z,l.x=h.x-n.x,l.y=h.y-n.y,l.z=h.z-n.z,u.x=a.y*l.z-l.y*a.z,u.y=a.z*l.x-l.z*a.x,u.z=a.x*l.y-l.x*a.y,m+=Math.sqrt(u.x*u.x+u.y*u.y+u.z*u.z);return.5*m},Smal.normalizeDegree=function(t){let i=t%360;return i>180?i-=360:i<=-180&&(i+=360),i},Smal.normalizeRadian=function(t){const i=2*Math.PI;let e=t%i;return e>Math.PI?e-=i:e<=-Math.PI&&(e+=i),e};